<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Japanese Learning App</title>
    <link rel="stylesheet" href="styles.css?v=14">
</head>
<body>
    <div class="header">
        <h1>üóæ Japanese Learning App</h1>
        <p>Your one-stop shop for customized kanji and vocabulary learning!</p>
        <div class="user-selector">
            <label for="currentUser">Current User:</label>
            <select id="currentUser" onchange="userChanged()">
                <option value="1">testuser</option>
                <option value="2">friend1</option>
            </select>
        </div>
    </div>
    
    <div class="nav-buttons">
        <button class="nav-btn active" onclick="showKanji()">Kanji Dictionary</button>
        <button class="nav-btn" onclick="showWords()">Word Dictionary</button>
        <button class="nav-btn" onclick="showQuiz()">Quiz</button>
    </div>
    
    <div class="search-box">
        <input type="text" class="search-input" id="searchInput" placeholder="Search kanji or words...">
        <button class="search-btn" onclick="searchItems()">Search</button>
        <button class="search-btn" onclick="showAll()" style="background-color: #6c7b7f;">Show All</button>
    </div>
    
    <!-- JLPT Level Filter (only shows for kanji) -->
    <div class="filter-box" id="jlptFilter" style="display: none;">
        <label for="jlptSelect">Filter by JLPT Level:</label>
        <select id="jlptSelect" onchange="filterByJLPT()">
            <option value="">All Levels</option>
            <option value="N5">N5</option>
            <option value="N4">N4</option>
            <option value="N3">N3</option>
            <option value="N2">N2</option>
            <option value="N1">N1</option>
            <option value="NULL">No JLPT Level</option>
        </select>
    </div>
    
    <!-- Quiz Selection Filter -->
    <div class="filter-box">
        <label for="quizFilter">Show:</label>
        <select id="quizFilter" onchange="filterByQuizSelection()">
            <option value="all">All Items</option>
            <option value="selected">Selected for Quiz</option>
            <option value="unselected">Not Selected for Quiz</option>
        </select>
    </div>
    
    <div id="content" class="container">
        <div class="loading">Loading kanji...</div>
    </div>
    
    <!-- Pagination Controls -->
    <div class="pagination" id="pagination" style="display: none;">
        <button class="page-btn" id="prevBtn" onclick="previousPage()">&laquo; Previous</button>
        <span class="page-info" id="pageInfo">Page 1 of 1</span>
        <button class="page-btn" id="nextBtn" onclick="nextPage()">Next &raquo;</button>
    </div>

<!--script src="https://www.google.com/recaptcha/api.js?render=6LdnA4krAAAAACqy1umabGKSSfkT2Bt35LLRSvPA"-->
<script>
let currentView = 'kanji';
let currentPage = 1;
let itemsPerPage = 30;
let totalItems = [];
let filteredItems = [];
let userSelections = new Set(); // Track which items are selected for current user
let currentSort = 'random'; // Default: keep current randomized behavior

// Quiz variables
let quizData = [];
let currentQuestionIndex = 0;
let quizResults = [];
let currentQuestion = null;
let hasAnswered = false;

// Quiz Timing Variables
let quizStartTime = null;
let quizEndTime = null;
let currentQuizType = null; // 'kanji', 'word', or 'mixed'

// Authentication state
let isAuthenticated = false;
let currentUser = null;

// Check authentication status on page load
window.onload = function() {
    checkAuthenticationStatus();
};

function checkAuthenticationStatus() {
    fetch('/api/auth-status')
        .then(response => response.json())
        .then(data => {
            if (data.authenticated) {
                isAuthenticated = true;
                currentUser = data.user;
                showMainApp();
            } else {
                isAuthenticated = false;
                currentUser = null;
                showLoginScreen();
            }
        })
        .catch(error => {
            console.error('Auth check error:', error);
            showLoginScreen();
        });
}

function showLoginScreen() {
    const content = document.body;
    content.innerHTML = `
        <div class="login-container">
            <div class="login-box">
                <h1>üóæ Kanji Wizard | Japanese Learning App</h1>
                
                <!-- Tab Navigation -->
                <div class="login-tabs">
                    <button class="tab-btn active" onclick="showLoginTab()">Login</button>
                    <button class="tab-btn" onclick="showRegisterTab()">Create Free Account</button>
                </div>
                
                <!-- Login Tab -->
                <div id="loginTab" class="tab-content active">
                    <h2>Login to Your Account</h2>
                    
                    <form id="loginForm" onsubmit="handleLogin(event)">
                        <div class="login-field">
                            <label for="username">Username:</label>
                            <input type="text" id="username" name="username" required>
                        </div>
                        
                        <div class="login-field">
                            <label for="password">Password:</label>
                            <input type="password" id="password" name="password" required>
                        </div>
                        
                        <div class="login-field">
                            <label class="checkbox-label">
                                <input type="checkbox" id="rememberMe" checked>
                                Remember me for 30 days
                            </label>
                        </div>
                        
                        <button type="submit" class="login-btn" id="loginButton">
                            Login
                        </button>
                    </form>
                    
                    <div id="loginError" class="login-error" style="display: none;"></div>
                    
                    <!-- Forgot Password Section -->
                    <div class="forgot-password-section">
                        <button type="button" class="forgot-password-link" onclick="showForgotPasswordModal()">
                            üîë Forgot Password?
                        </button>
                    </div>

                    <!-- Guest Section -->
                    <div class="guest-section">
                        <h3>Or browse as guest</h3>
                        <p>View N5-level content only (no progress saving)</p>
                        <button class="guest-btn" onclick="browseAsGuest()">
                            Browse as Guest
                        </button>
                    </div>
                </div>
                
                <!-- Free Registration Tab -->
                <div id="registerTab" class="tab-content">
                    <h2>Create Free Account</h2>
                    <p class="register-subtitle">Access N5 + N4 content with progress saving</p>
                    
                    <form id="registerForm" onsubmit="handleFreeRegistration(event)">
                        <div class="login-field">
                            <label for="regUsername">Username:</label>
                            <input type="text" id="regUsername" name="username" required 
                                   minlength="3" maxlength="20" pattern="[a-zA-Z0-9_]+"
                                   title="3-20 characters, letters, numbers, and underscores only">
                            <small>3-20 characters, letters, numbers, and underscores only</small>
                            <div id="regUsernameStatus" class="username-status"></div>
                        </div>
                        
                        <div class="login-field">
                            <label for="regEmail">Email Address:</label>
                            <input type="email" id="regEmail" name="email" required>
                            <small>We'll send your login credentials to this email</small>
                        </div>

                        <div class="login-field">
                            <label for="mathQuestion">Security Question:</label>
                            <div id="mathQuestion" style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin: 8px 0; font-weight: bold; color: #333;">Loading...</div>
                            <input type="number" id="mathAnswer" name="mathAnswer" required 
                                   placeholder="Enter your answer">
                            <input type="hidden" id="mathToken" name="mathToken">
                        </div>

                        <input type="text" name="website" id="website" 
                       style="display: none !important; visibility: hidden !important;" 
                       tabindex="-1" autocomplete="off">
                        
                        <div class="features-preview">
                            <h4>‚ú® What You Get:</h4>
                            <ul>
                                <li>üìö Access to N5 and N4 content</li>
                                <li>üíæ Save your progress and quiz selections</li>
                                <li>üìä Track your learning statistics</li>
                                <li>üéØ Create custom quizzes</li>
                            </ul>
                        </div>
                        
                        <button type="submit" class="login-btn" id="registerButton">
                            Create Free Account
                        </button>
                    </form>
                    
                    <div id="registerError" class="login-error" style="display: none;"></div>
                    <div id="registerSuccess" class="register-success" style="display: none;"></div>
                    
                    <div class="upgrade-notice">
                        <p><strong>Want all JLPT levels?</strong> Upgrade for just $9.99 after creating your account!</p>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Set up username validation for registration
    setupRegisterUsernameValidation();
}

function loadMathChallenge() {
    fetch('/api/math-challenge')
        .then(response => response.json())
        .then(data => {
            document.getElementById('mathQuestion').textContent = data.question;
            document.getElementById('mathToken').value = data.token;
        })
        .catch(error => {
            console.error('Math challenge error:', error);
            document.getElementById('mathQuestion').textContent = 'What is 2 + 2?';
        });
}

function showLoginTab() {
    document.getElementById('loginTab').classList.add('active');
    document.getElementById('registerTab').classList.remove('active');
    document.querySelectorAll('.tab-btn')[0].classList.add('active');
    document.querySelectorAll('.tab-btn')[1].classList.remove('active');
}

function showRegisterTab() {
    document.getElementById('registerTab').classList.add('active');
    document.getElementById('loginTab').classList.remove('active');
    document.querySelectorAll('.tab-btn')[1].classList.add('active');
    document.querySelectorAll('.tab-btn')[0].classList.remove('active');
    
    // Load math challenge when tab opens
    loadMathChallenge();
}
function handleFreeRegistration(event) {
    event.preventDefault();
    
    const username = document.getElementById('regUsername').value.trim();
    const email = document.getElementById('regEmail').value.trim();
    const mathAnswer = document.getElementById('mathAnswer').value;
    const mathToken = document.getElementById('mathToken').value;
    const registerButton = document.getElementById('registerButton');
    const errorDiv = document.getElementById('registerError');
    const successDiv = document.getElementById('registerSuccess');
    
    // Clear previous messages
    errorDiv.style.display = 'none';
    successDiv.style.display = 'none';

    // Validate inputs (your existing validation)
    if (!username || !email) {
        showRegisterError('Please fill in all fields');
        return;
    }
    
    if (!mathAnswer) {
        showRegisterError('Please solve the math problem');
        return;
    }
    
    // Validate inputs
    if (username.length < 3 || username.length > 20) {
        showRegisterError('Username must be between 3 and 20 characters');
        return;
    }
    
    if (!/^[a-zA-Z0-9_]+$/.test(username)) {
        showRegisterError('Username can only contain letters, numbers, and underscores');
        return;
    }
    
    if (!validateEmail(email)) {
        showRegisterError('Please enter a valid email address');
        return;
    }
    
    // Check if username is available
    const statusDiv = document.getElementById('regUsernameStatus');
    if (!statusDiv.classList.contains('available')) {
        showRegisterError('Please choose an available username');
        return;
    }
    
    // Disable button and show loading
    registerButton.disabled = true;
    registerButton.textContent = 'Creating Account...';
    
 fetch('/api/register-free', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ 
            username: username, 
            email: email,
            website: '', // Honeypot field
            mathAnswer: mathAnswer,
            mathToken: mathToken
        })
    })
    .then(function(response) {
        return response.json();
    })
    .then(function(data) {
        if (data.success) {
            showRegisterSuccess('Account created successfully! Check your email for login credentials.');
            document.getElementById('registerForm').reset();
            document.getElementById('regUsernameStatus').innerHTML = '';
            
            setTimeout(function() {
                showLoginTab();
            }, 3000);
        } else {
            showRegisterError(data.error || 'Registration failed');
        }
    })
    .catch(function(error) {
        console.error('Registration error:', error);
        showRegisterError('Connection error. Please try again.');
    })
    .finally(function() {
        registerButton.disabled = false;
        registerButton.textContent = 'Create Free Account';
    });
}


// üîß UPDATED: Make submitRegistration handle null tokens gracefully
function submitRegistration(username, email, recaptchaToken, registerButton, errorDiv, successDiv) {
    registerButton.textContent = 'Creating Account...';
    
    const requestBody = { 
        username: username, 
        email: email
    };
    
    // Only add reCAPTCHA token if we have one
    if (recaptchaToken) {
        requestBody.recaptchaToken = recaptchaToken;
    }
    
    fetch('/api/register-free', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(requestBody)
    })
    .then(function(response) {
        return response.json();
    })
    .then(function(data) {
        if (data.success) {
            showRegisterSuccess('Account created successfully! Check your email for login credentials.');
            // Clear the form
            document.getElementById('registerForm').reset();
            document.getElementById('regUsernameStatus').innerHTML = '';
            
            // Switch to login tab after a delay
            setTimeout(function() {
                showLoginTab();
            }, 3000);
        } else {
            showRegisterError(data.error || 'Registration failed');
        }
    })
    .catch(function(error) {
        console.error('Registration error:', error);
        showRegisterError('Connection error. Please try again.');
    })
    .finally(function() {
        registerButton.disabled = false;
        registerButton.textContent = 'Create Free Account';
    });
}
    
function showRegisterError(message) {
    const errorDiv = document.getElementById('registerError');
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
}

function showRegisterSuccess(message) {
    const successDiv = document.getElementById('registerSuccess');
    successDiv.innerHTML = message;
    successDiv.style.display = 'block';
}

function setupRegisterUsernameValidation() {
    const usernameInput = document.getElementById('regUsername');
    const statusDiv = document.getElementById('regUsernameStatus');
    let debounceTimer;
    
    if (!usernameInput || !statusDiv) return;
    
    usernameInput.addEventListener('input', function() {
        const username = this.value.trim();
        
        // Clear previous timer
        clearTimeout(debounceTimer);
        
        // Reset status
        statusDiv.innerHTML = '';
        statusDiv.className = 'username-status';
        
        if (username.length < 3) {
            if (username.length > 0) {
                statusDiv.innerHTML = '‚ö†Ô∏è Username must be at least 3 characters';
                statusDiv.className = 'username-status error';
            }
            return;
        }
        
        if (username.length > 20) {
            statusDiv.innerHTML = '‚ö†Ô∏è Username must be 20 characters or less';
            statusDiv.className = 'username-status error';
            return;
        }
        
        if (!/^[a-zA-Z0-9_]+$/.test(username)) {
            statusDiv.innerHTML = '‚ö†Ô∏è Only letters, numbers, and underscores allowed';
            statusDiv.className = 'username-status error';
            return;
        }
        
        // Show checking status
        statusDiv.innerHTML = 'üîç Checking availability...';
        statusDiv.className = 'username-status checking';
        
        // Debounce the API call
        debounceTimer = setTimeout(function() {
            checkRegisterUsernameAvailability(username);
        }, 500);
    });
}

function checkRegisterUsernameAvailability(username) {
    const statusDiv = document.getElementById('regUsernameStatus');
    
    fetch('/api/check-username', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ username: username })
    })
    .then(function(response) {
        return response.json();
    })
    .then(function(data) {
        if (data.available) {
            statusDiv.innerHTML = '‚úÖ Username available';
            statusDiv.className = 'username-status available';
        } else {
            statusDiv.innerHTML = '‚ùå Username already taken';
            statusDiv.className = 'username-status taken';
        }
    })
    .catch(function(error) {
        console.error('Error checking username:', error);
        statusDiv.innerHTML = '‚ö†Ô∏è Could not check availability';
        statusDiv.className = 'username-status error';
    });
}
    
function showForgotPasswordModal() {
    // Create modal if it doesn't exist
    let modal = document.getElementById('forgotPasswordModal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'forgotPasswordModal';
        modal.className = 'modal';
        modal.innerHTML = `
            <div class="modal-content">
                <span class="close" onclick="closeForgotPasswordModal()">&times;</span>
                <div class="modal-header">
                    <h2>üîë Reset Your Password</h2>
                    <p>Enter your username and we'll send you a new password</p>
                </div>
                
                <form id="forgotPasswordForm" onsubmit="handleForgotPassword(event)">
                    <div class="modal-field">
                        <label for="forgotUsername">Username:</label>
                        <input type="text" id="forgotUsername" required 
                               placeholder="Enter your username" 
                               autocomplete="username">
                    </div>
                    
                    <div class="security-notice">
                        <p><strong>üîí Security Notice:</strong></p>
                        <p>If your username exists in our database, we will send a new temporary password to the email address associated with your account.</p>
                        <p>If you don't receive an email within 5 minutes, please contact <a href="mailto:support@thekanjiwizard.com">support@thekanjiwizard.com</a></p>
                    </div>
                    
                    <div id="forgotPasswordMessage"></div>
                    
                    <div class="modal-actions">
                        <button type="submit" class="modal-btn primary" id="resetPasswordBtn">
                            üìß Send New Password
                        </button>
                        <button type="button" class="modal-btn secondary" onclick="closeForgotPasswordModal()">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        `;
        document.body.appendChild(modal);
    }
    
    modal.style.display = 'block';
    
    // Focus on username input
    setTimeout(() => {
        document.getElementById('forgotUsername').focus();
    }, 100);
    
    // Close modal when clicking outside
    modal.onclick = function(event) {
        if (event.target === modal) {
            closeForgotPasswordModal();
        }
    };
}

function closeForgotPasswordModal() {
    const modal = document.getElementById('forgotPasswordModal');
    if (modal) {
        modal.style.display = 'none';
        document.getElementById('forgotPasswordForm').reset();
        document.getElementById('forgotPasswordMessage').innerHTML = '';
    }
}

function handleForgotPassword(event) {
    event.preventDefault();
    
    const username = document.getElementById('forgotUsername').value.trim();
    const messageDiv = document.getElementById('forgotPasswordMessage');
    const resetBtn = document.getElementById('resetPasswordBtn');
    
    if (!username) {
        messageDiv.innerHTML = '<div class="message error">Please enter your username</div>';
        return;
    }
    
    // Disable button and show loading
    resetBtn.disabled = true;
    resetBtn.textContent = 'Sending...';
    messageDiv.innerHTML = '';
    
    fetch('/api/forgot-password', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ username: username })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            messageDiv.innerHTML = `
                <div class="message success">
                    <strong>‚úÖ Password Reset Requested</strong><br>
                    If your username exists in our database, we've sent a new temporary password to your registered email address.<br><br>
                    <strong>Next steps:</strong><br>
                    1. Check your email (including spam folder)<br>
                    2. Log in with your new temporary password<br>
                    3. Change your password after logging in<br><br>
                    <small>If you don't receive an email within 5 minutes, please contact support@thekanjiwizard.com</small>
                </div>
            `;
            
            // Change button text
            resetBtn.textContent = '‚úÖ Request Sent';
            
            // Auto-close modal after a delay
            setTimeout(() => {
                closeForgotPasswordModal();
            }, 8000);
            
        } else {
            messageDiv.innerHTML = `<div class="message error">Something went wrong. Please try again or contact support.</div>`;
            resetBtn.disabled = false;
            resetBtn.textContent = 'üìß Send New Password';
        }
    })
    .catch(error => {
        console.error('Forgot password error:', error);
        messageDiv.innerHTML = `
            <div class="message success">
                <strong>‚úÖ Password Reset Requested</strong><br>
                If your username exists in our database, we've sent a new temporary password to your registered email address.<br><br>
                If you don't receive an email within 5 minutes, please contact support@thekanjiwizard.com
            </div>
        `;
        resetBtn.textContent = '‚úÖ Request Sent';
        
        // Auto-close modal after a delay
        setTimeout(() => {
            closeForgotPasswordModal();
        }, 6000);
    });
}

function handleLogin(event) {
    event.preventDefault();
    
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    const loginButton = document.getElementById('loginButton');
    const errorDiv = document.getElementById('loginError');
    
    // Disable button and show loading
    loginButton.disabled = true;
    loginButton.textContent = 'Logging in...';
    errorDiv.style.display = 'none';
    
    fetch('/api/login', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ username, password })
    })
    .then(response => response.json())
.then(data => {
    if (data.success) {
        isAuthenticated = true;
        currentUser = data.user;
        showMainApp();
        
        // Check if user has temporary password after login
        setTimeout(() => {
            checkTemporaryPassword();
        }, 1500);
    } else {
        showLoginError(data.error || 'Login failed');
    }
})
    .catch(error => {
        console.error('Login error:', error);
        showLoginError('Connection error. Please try again.');
    })
    .finally(() => {
        loginButton.disabled = false;
        loginButton.textContent = 'Login';
    });


}

function showLoginError(message) {
    const errorDiv = document.getElementById('loginError');
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
}

function browseAsGuest() {
    isAuthenticated = false;
    currentUser = null;
    showMainApp();
}

function showMainApp() {
    // Restore the original HTML structure
    const content = document.body;
    content.innerHTML = `
        <div class="header">
            <h1>üóæ Kanji Wizard | Japanese Learning App</h1>
            <p>Your one-stop shop for customized kanji and vocabulary learning!</p>
            ${isAuthenticated ? createUserHeader() : createGuestHeader()}
        </div>
        
        <div class="nav-buttons">
            <button class="nav-btn active" onclick="showKanji()">Kanji Dictionary</button>
            <button class="nav-btn" onclick="showWords()">Word Dictionary</button>
            <button class="nav-btn" onclick="showQuiz()">Quiz</button>
            ${isAuthenticated ? '<button class="nav-btn" onclick="showProfile()">Profile</button>' : ''}
            ${createPricingButton()}
            <button class="nav-btn" onclick="showComingSoon()">Coming Soon</button>
            <button class="nav-btn" onclick="showAbout()">About</button>
            <button class="nav-btn" onclick="showSources()">Sources</button>
        </div>
        
        <div class="search-box">
            <input type="text" class="search-input" id="searchInput" placeholder="Search kanji or words...">
            <button class="search-btn" onclick="searchItems()">Search</button>
            <button class="search-btn" onclick="showAll()" style="background-color: #6c7b7f;">Show All</button>
        </div>
        
        <!-- JLPT Level Filter -->
        <div class="filter-box" id="jlptFilter" style="display: none;">
            <label for="jlptSelect">Filter by JLPT Level:</label>
            <select id="jlptSelect" onchange="filterByJLPT()">
                <option value="">All Levels</option>
                <option value="N5">N5</option>
                ${getJLPTFilterOptions()}
            </select>
        </div>
        
        <!-- NEW: Frequency Sort Filter -->
        <div class="filter-box" id="sortFilter" style="display: none;">
            <label for="sortSelect">Sort by Frequency:</label>
            <select id="sortSelect" onchange="sortByFrequency()">
                <option value="random">Random Order (Default)</option>
                <option value="frequency_asc">Most Frequent First (1‚Üíhigh)</option>
                <option value="frequency_desc">Least Frequent First (high‚Üí1)</option>
            </select>
        </div>
        
        <!-- Quiz Selection Filter (only for authenticated users) -->
        ${isAuthenticated ? `
        <div class="filter-box">
            <label for="quizFilter">Show:</label>
            <select id="quizFilter" onchange="filterByQuizSelection()">
                <option value="all">All Items</option>
                <option value="selected">Selected for Quiz</option>
                <option value="unselected">Not Selected for Quiz</option>
            </select>
        </div>
        ` : ''}
        
        <div id="content" class="container">
            <div class="loading">Loading kanji...</div>
        </div>
        
        <!-- Pagination Controls -->
        <div class="pagination" id="pagination" style="display: none;">
            <button class="page-btn" id="prevBtn" onclick="previousPage()">&laquo; Previous</button>
            <span class="page-info" id="pageInfo">Page 1 of 1</span>
            <button class="page-btn" id="nextBtn" onclick="nextPage()">Next &raquo;</button>
        </div>
    `;
    
    // Initialize the app
    showKanji();
    
    // Set up search enter key handler
    document.getElementById('searchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchItems();
        }
    });

    setTimeout(function() {
        checkTemporaryPassword();
    }, 1000);
}

function createPricingButton() {
    console.log('üß™ createPricingButton DEBUG:', {
        isAuthenticated: isAuthenticated,
        currentUser: currentUser,
        hasRole: currentUser && currentUser.role,
        roleValue: currentUser ? currentUser.role : 'no user',
        roleType: currentUser ? typeof currentUser.role : 'no user'
    });
    
    if (!isAuthenticated) {
        console.log('‚Üí Returning Pricing button (guest)');
        return '<button class="nav-btn" onclick="showPricing()">Pricing</button>';
    } else if (currentUser && currentUser.role == 'registered') {
        console.log('‚Üí Returning Upgrade button (registered)');
        return '<button class="nav-btn upgrade-available" onclick="showPricing()">Upgrade</button>';
    } else {
        console.log('‚Üí Returning no button (paid user)');
        return '';
    }
}

// Helper function to get JLPT filter options based on user role
function getJLPTFilterOptions() {
    if (!isAuthenticated) {
        return '';
    } else if (currentUser && currentUser.role == 'registered') {
        // Registered users: only N4 (they already see N5 in the default option)
        return '<option value="N4">N4</option>';
    } else {
        // Paid users: all levels
        return `
            <option value="N4">N4</option>
            <option value="N3">N3</option>
            <option value="N2">N2</option>
            <option value="N1">N1</option>
            <option value="NULL">No JLPT Level</option>
        `;
    }
}


function createUserHeader() {
    return `
        <div class="user-info">
            <span class="welcome-text">Welcome, ${currentUser.username}!</span>
            <span class="user-role-badge ${currentUser.role}">${currentUser.role == 'paid' ? 'Full Access' : 'Free Account'}</span>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
    `;
}

function createGuestHeader() {
    return `
        <div class="guest-info">
            <span class="guest-text">Browsing as Guest (N5 content only)</span>
            <button class="login-btn-small" onclick="showLoginScreen()">Login</button>
        </div>
    `;
}

function logout() {
    fetch('/api/logout', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                isAuthenticated = false;
                currentUser = null;
                showLoginScreen();
            }
        })
        .catch(error => {
            console.error('Logout error:', error);
            // Force logout anyway
            isAuthenticated = false;
            currentUser = null;
            showLoginScreen();
        });
}

function getCurrentUserId() {
    if (isAuthenticated && currentUser) {
        return currentUser.id;
    }
    return null; // Guest mode
}

function userChanged() {
    userSelections.clear();
    if (currentView === 'kanji') {
        loadKanji();
    } else {
        loadWords();
    }
}

function showKanji() {
    currentView = 'kanji';
    currentPage = 1;
    updateNavButtons('kanji');
    
    // Show dictionary elements
    document.getElementById('jlptFilter').style.display = 'block';
    document.getElementById('sortFilter').style.display = 'block';
    document.querySelector('.search-box').style.display = 'block'; // Show search bar
    
    // Show quiz filter for authenticated users
    if (isAuthenticated && document.getElementById('quizFilter')) {
        document.getElementById('quizFilter').parentElement.style.display = 'block';
    }
    
    // In guest mode, automatically set to N5, otherwise allow all
    if (!isAuthenticated) {
        document.getElementById('jlptSelect').value = 'N5';
    } else {
        document.getElementById('jlptSelect').value = '';
    }
    
    // Reset sort to default
    document.getElementById('sortSelect').value = 'random';
    currentSort = 'random';
    
    // Only show quiz filter for authenticated users
    if (isAuthenticated) {
        document.getElementById('quizFilter').value = 'all';
    }
    
    // Ensure container uses grid layout for kanji cards
    document.getElementById('content').className = 'container';
    
    loadKanji();
}

function showWords() {
    currentView = 'words';
    currentPage = 1;
    updateNavButtons('words');
    
    // Show dictionary elements
    document.getElementById('jlptFilter').style.display = 'block';
    document.getElementById('sortFilter').style.display = 'block';
    document.querySelector('.search-box').style.display = 'block'; // Show search bar
    
    // Show quiz filter for authenticated users
    if (isAuthenticated && document.getElementById('quizFilter')) {
        document.getElementById('quizFilter').parentElement.style.display = 'block';
    }
    
    // In guest mode, automatically set to N5, otherwise allow all
    if (!isAuthenticated) {
        document.getElementById('jlptSelect').value = 'N5';
    } else {
        document.getElementById('jlptSelect').value = '';
    }
    
    // Reset sort to default
    document.getElementById('sortSelect').value = 'random';
    currentSort = 'random';
    
    // Only show quiz filter for authenticated users
    if (isAuthenticated) {
        document.getElementById('quizFilter').value = 'all';
    }
    
    // Ensure container uses grid layout for word cards
    document.getElementById('content').className = 'container';
    
    loadWords();
}

function sortByFrequency() {
    const sortValue = document.getElementById('sortSelect').value;
    currentSort = sortValue;
    
    console.log('üîÑ Sorting by:', sortValue);
    
    if (sortValue === 'frequency_asc') {
        // Most frequent first (lowest frequency_rank numbers first)
        totalItems.sort((a, b) => {
            const aFreq = a.frequency_rank || 999999;
            const bFreq = b.frequency_rank || 999999;
            return aFreq - bFreq;
        });
    } else if (sortValue === 'frequency_desc') {
        // Least frequent first (highest frequency_rank numbers first)
        totalItems.sort((a, b) => {
            const aFreq = a.frequency_rank || 0;
            const bFreq = b.frequency_rank || 0;
            return bFreq - aFreq;
        });
    } else if (sortValue === 'random') {
        // Re-randomize the array
        totalItems = shuffleArray([...totalItems]);
    }
    
    // Apply other filters and redisplay
    applyFilters();
}

function showQuiz() {
    currentView = 'quiz';
    updateNavButtons('quiz');
    
    // Hide ALL filters on Quiz page - you don't need them during the quiz!
    document.getElementById('jlptFilter').style.display = 'none';
    document.getElementById('sortFilter').style.display = 'none';
    
    // Hide quiz filter too - it's only for dictionary pages
    if (isAuthenticated && document.getElementById('quizFilter')) {
        document.getElementById('quizFilter').parentElement.style.display = 'none';
    }
    
    document.getElementById('pagination').style.display = 'none';
    document.querySelector('.search-box').style.display = 'none';
    
    // Remove grid layout for quiz - use block layout instead
    document.getElementById('content').className = '';
    
    loadQuizSetup();
}

function updateNavButtons(active) {
    const buttons = document.querySelectorAll('.nav-btn');
    buttons.forEach(btn => btn.classList.remove('active'));
    
    if (active === 'kanji') buttons[0].classList.add('active');
    if (active === 'words') buttons[1].classList.add('active');
    if (active === 'quiz') buttons[2] && buttons[2].classList.add('active');
    if (active === 'profile') {
        const profileBtn = Array.from(buttons).find(btn => btn.textContent === 'Profile');
        if (profileBtn) profileBtn.classList.add('active');
    }
    if (active === 'pricing') {
        const pricingBtn = Array.from(buttons).find(btn => btn.textContent === 'Pricing');
        if (pricingBtn) pricingBtn.classList.add('active');
    }
    if (active === 'coming-soon') {
        const comingSoonBtn = Array.from(buttons).find(btn => btn.textContent === 'Coming Soon');
        if (comingSoonBtn) comingSoonBtn.classList.add('active');
    }
    if (active === 'about') {
        const aboutBtn = Array.from(buttons).find(btn => btn.textContent === 'About');
        if (aboutBtn) aboutBtn.classList.add('active');
    }
    if (active === 'sources') {
        const sourcesBtn = Array.from(buttons).find(btn => btn.textContent === 'Sources');
        if (sourcesBtn) sourcesBtn.classList.add('active');
    }
}

function loadKanji() {
    const content = document.getElementById('content');
    content.innerHTML = '<div class="loading">Loading kanji...</div>';
    
    console.log('üêõ loadKanji called, isAuthenticated:', isAuthenticated);
    
    if (isAuthenticated) {
        Promise.all([
            fetch('/api/kanji').then(response => {
                console.log('üêõ Kanji API response status:', response.status);
                return response.json();
            }),
            loadUserSelections('kanji')
        ]).then(([data]) => {
            console.log('üêõ Kanji data received:', data);
            console.log('üêõ Data type:', typeof data);
            console.log('üêõ Is array:', Array.isArray(data));
            console.log('üêõ Data length:', data ? data.length : 'no length');
            console.log('üêõ First item:', data && data[0] ? data[0] : 'no first item');
            console.log('üêõ About to shuffle array...');
            totalItems = shuffleArray(data);
            console.log('üêõ Shuffled, totalItems length:', totalItems.length); 
            filteredItems = totalItems;
            console.log('üêõ Set filteredItems, length:', filteredItems.length);
            currentPage = 1;
            console.log('üêõ About to call displayPaginatedItems()...');
            displayPaginatedItems();
            console.log('üêõ displayPaginatedItems() completed');
        }).catch(error => {
            console.error('üêõ Kanji loading error:', error);
            content.innerHTML = '<div class="error">Error loading kanji: ' + error.message + '</div>';
        });
    } else {
        // Guest mode - just load kanji
        fetch('/api/kanji')
            .then(response => {
                console.log('üêõ Guest kanji API response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('üêõ Guest kanji data received:', data);
                console.log('üêõ Guest data type:', typeof data);
                console.log('üêõ Guest is array:', Array.isArray(data));
                console.log('üêõ Guest data length:', data ? data.length : 'no length');
                console.log('üêõ Guest first item:', data && data[0] ? data[0] : 'no first item');
                
                totalItems = shuffleArray(data);
                filteredItems = totalItems;
                currentPage = 1;
                displayPaginatedItems();
            })
            .catch(error => {
                console.error('üêõ Guest kanji loading error:', error);
                content.innerHTML = '<div class="error">Error loading kanji: ' + error.message + '</div>';
            });
    }
}
function loadWords() {
    const content = document.getElementById('content');
    content.innerHTML = '<div class="loading">Loading words...</div>';
    
    // For guests, we don't need to load user selections
    if (isAuthenticated) {
        Promise.all([
            fetch('/api/words').then(response => response.json()),
            loadUserSelections('word')
        ]).then(([data]) => {
            totalItems = shuffleArray(data);
            filteredItems = totalItems;
            currentPage = 1;
            displayPaginatedItems();
        }).catch(error => {
            content.innerHTML = '<div class="error">Error loading words: ' + error.message + '</div>';
        });
    } else {
        // Guest mode - just load words
        fetch('/api/words')
            .then(response => response.json())
            .then(data => {
                totalItems = shuffleArray(data);
                filteredItems = totalItems;
                currentPage = 1;
                displayPaginatedItems();
            })
            .catch(error => {
                content.innerHTML = '<div class="error">Error loading words: ' + error.message + '</div>';
            });
    }
}

function loadUserSelections(itemType) {
    const userId = getCurrentUserId();
    return fetch(`/api/user-selections/${userId}/${itemType}`)
        .then(response => response.json())
        .then(selections => {
            userSelections.clear();
            selections.forEach(item => {
                userSelections.add(item.item_id);
            });
        })
        .catch(error => {
            console.error('Error loading user selections:', error);
            userSelections.clear();
        });
}

function toggleSelection(itemId) {
    const userId = getCurrentUserId();
    const itemType = currentView === 'kanji' ? 'kanji' : 'word';
    const isSelected = userSelections.has(itemId);
    
    const method = isSelected ? 'DELETE' : 'POST';
    const url = `/api/user-selections/${userId}/${itemType}/${itemId}`;
    
    fetch(url, { method: method })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                if (isSelected) {
                    userSelections.delete(itemId);
                } else {
                    userSelections.add(itemId);
                }
                updateToggleButton(itemId, !isSelected);
                //applyFilters();
                displayPaginatedItems();
            }
        })
        .catch(error => {
            console.error('Error toggling selection:', error);
        });
}

function updateToggleButton(itemId, isSelected) {
    const button = document.querySelector(`[data-item-id="${itemId}"]`);
    if (button) {
        button.textContent = isSelected ? '‚úì Selected' : '+ Add to Quiz';
        button.className = isSelected ? 'toggle-btn selected' : 'toggle-btn';
    }
}

function displayPaginatedItems() {
    console.log('üêõ displayPaginatedItems called');
    console.log('üêõ currentView:', currentView);
    console.log('üêõ filteredItems.length:', filteredItems.length);
    console.log('üêõ currentPage:', currentPage);
    console.log('üêõ itemsPerPage:', itemsPerPage);
    
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const pageItems = filteredItems.slice(startIndex, endIndex);
    
    console.log('üêõ startIndex:', startIndex, 'endIndex:', endIndex);
    console.log('üêõ pageItems.length:', pageItems.length);
    console.log('üêõ pageItems[0]:', pageItems[0]);
    
    if (currentView === 'kanji') {
        console.log('üêõ About to call displayKanji with', pageItems.length, 'items');
        displayKanji(pageItems);
        console.log('üêõ displayKanji completed');
    } else {
        console.log('üêõ About to call displayWords with', pageItems.length, 'items');
        displayWords(pageItems);
        console.log('üêõ displayWords completed');
    }
    
    updatePagination();
}

function updatePagination() {
    const totalPages = Math.ceil(filteredItems.length / itemsPerPage);
    const pagination = document.getElementById('pagination');
    const pageInfo = document.getElementById('pageInfo');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    
    if (totalPages > 1) {
        pagination.style.display = 'flex';
        pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
        prevBtn.disabled = currentPage === 1;
        nextBtn.disabled = currentPage === totalPages;
    } else {
        pagination.style.display = 'none';
    }
}

function previousPage() {
    if (currentPage > 1) {
        currentPage--;
        displayPaginatedItems();
    }
}

function nextPage() {
    const totalPages = Math.ceil(filteredItems.length / itemsPerPage);
    if (currentPage < totalPages) {
        currentPage++;
        displayPaginatedItems();
    }
}

function filterByJLPT() {
    // Check if user is currently searching
    const searchTerm = document.getElementById('searchInput').value.trim();
    
    if (searchTerm) {
        // If there's a search term, re-run the search with new JLPT filter
        console.log('üîÑ JLPT filter changed during search, re-running search');
        searchItems();
    } else {
        // If no search term, apply normal filtering
        applyFilters();
    }
}

function filterByQuizSelection() {
    applyFilters();
}

function applyFilters() {
    let filtered = totalItems;
    
    // Apply JLPT filter (for both kanji AND words now)
    if (currentView === 'kanji' || currentView === 'words') {  // <-- Add words here
        const selectedLevel = document.getElementById('jlptSelect').value;
        if (selectedLevel !== '') {
            if (selectedLevel === 'NULL') {
                // Filter for items with no JLPT level (null values)
                filtered = filtered.filter(item => item.jlpt_level === null || item.jlpt_level === '');
            } else {
                // Filter for specific JLPT level
                filtered = filtered.filter(item => item.jlpt_level === selectedLevel);
            }
        }
    }
    
    // Apply quiz selection filter
    const quizFilter = document.getElementById('quizFilter').value;
    if (quizFilter === 'selected') {
        filtered = filtered.filter(item => userSelections.has(item.id));
    } else if (quizFilter === 'unselected') {
        filtered = filtered.filter(item => !userSelections.has(item.id));
    }
    
    filteredItems = filtered;
    currentPage = 1;
    displayPaginatedItems();
}

function shuffleArray(array) {
    const shuffled = [...array];
    for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
    }
    return shuffled;
}

// QUIZ FUNCTIONS
function loadQuizSetup() {
    const content = document.getElementById('content');
    content.className = '';
    content.innerHTML = '<div class="loading">Loading quiz setup...</div>';
    
    if (!isAuthenticated) {
        // Guest mode - show sample quiz options
        displayGuestQuizSetup();
        return;
    }
    
    // Authenticated user - existing logic
    Promise.all([
        loadUserQuizItems('kanji'),
        loadUserQuizItems('word')
    ]).then(([kanjiItems, wordItems]) => {
        const totalSelected = kanjiItems.length + wordItems.length;
        displayQuizSetup(totalSelected, kanjiItems, wordItems);
    }).catch(error => {
        content.innerHTML = '<div class="error">Error loading quiz data: ' + error.message + '</div>';
    });
}

function loadUserQuizItems(itemType) {
    const userId = getCurrentUserId();
    return fetch(`/api/user-quiz-items/${userId}/${itemType}`)
        .then(response => response.json())
        .catch(error => {
            console.error('Error loading quiz items:', error);
            return [];
        });
}

function displayQuizSetup(totalSelected, kanjiItems, wordItems) {
    const content = document.getElementById('content');
    
    if (totalSelected === 0) {
        content.innerHTML = `
            <div class="quiz-setup">
                <h2>No Quiz Items Selected</h2>
                <p>You haven't selected any kanji or words for the quiz yet.</p>
                <p>Go to the Kanji Dictionary or Word Dictionary and click "+ Add to Quiz" on items you want to study.</p>
                <button class="quiz-btn" onclick="showKanji()">Go to Kanji Dictionary</button>
            </div>
        `;
        return;
    }
    
    content.innerHTML = `
        <div class="quiz-setup">
            <h2>üß† Start Quiz</h2>
            <div class="quiz-stats">
                <p><strong>Available Items:</strong> ${totalSelected} total</p>
                <p>‚Ä¢ ${kanjiItems.length} kanji selected</p>
                <p>‚Ä¢ ${wordItems.length} words selected</p>
            </div>
            
            <div class="quiz-type-selection">
                <h3>Choose Quiz Type:</h3>
                <div class="quiz-type-buttons">
                    ${kanjiItems.length > 0 ? `<button class="quiz-type-btn" onclick="setupQuizType('kanji', ${kanjiItems.length})">
                        <div class="quiz-type-title">üìù Kanji Quiz</div>
                        <div class="quiz-type-desc">${kanjiItems.length} kanji available</div>
                        <div class="quiz-type-format">Kanji ‚Üí Meaning + Readings</div>
                    </button>` : ''}
                    
                    ${wordItems.length > 0 ? `<button class="quiz-type-btn" onclick="setupQuizType('words', ${wordItems.length})">
                        <div class="quiz-type-title">üí¨ Word Quiz</div>
                        <div class="quiz-type-desc">${wordItems.length} words available</div>
                        <div class="quiz-type-format">Word ‚Üí Meaning</div>
                    </button>` : ''}
                    
                    ${kanjiItems.length > 0 && wordItems.length > 0 ? `<button class="quiz-type-btn" onclick="setupQuizType('mixed', ${totalSelected})">
                        <div class="quiz-type-title">üîÄ Mixed Quiz</div>
                        <div class="quiz-type-desc">Kanji + Words mixed</div>
                        <div class="quiz-type-format">Random selection</div>
                    </button>` : ''}
                </div>
            </div>
            
            <div class="quiz-actions">
                <button class="quiz-btn secondary" onclick="showKanji()">Back to Dictionary</button>
            </div>
        </div>
    `;
}

function displayGuestQuizSetup() {
    const content = document.getElementById('content');
    
    content.innerHTML = `
        <div class="quiz-setup">
            <h2>üß† Try Our Quiz System!</h2>
            
            <div class="guest-quiz-notice">
                <h3>üéØ Demo Mode</h3>
                <p>As a guest, you can try our quiz system with N5-level content!</p>
                <p><strong>Features available:</strong></p>
                <ul>
                    <li>‚úÖ Quiz on N5 kanji and vocabulary</li>
                    <li>‚úÖ Multiple choice questions</li>
                    <li>‚úÖ Instant feedback</li>
                    <li>‚ùå Progress tracking (requires account)</li>
                    <li>‚ùå Custom word selection (requires account)</li>
                </ul>
            </div>
            
            <div class="quiz-type-selection">
                <h3>Choose Demo Quiz Type:</h3>
                <div class="quiz-type-buttons">
                    <button class="quiz-type-btn" onclick="startGuestQuiz('kanji')">
                        <div class="quiz-type-title">üìù N5 Kanji Quiz</div>
                        <div class="quiz-type-desc">Random N5 kanji</div>
                        <div class="quiz-type-format">Kanji ‚Üí Meaning + Readings</div>
                    </button>
                    
                    <button class="quiz-type-btn" onclick="startGuestQuiz('words')">
                        <div class="quiz-type-title">üí¨ N5 Word Quiz</div>
                        <div class="quiz-type-desc">Random N5 vocabulary</div>
                        <div class="quiz-type-format">Word ‚Üí Meaning</div>
                    </button>
                    
                    <button class="quiz-type-btn" onclick="startGuestQuiz('mixed')">
                        <div class="quiz-type-title">üîÄ Mixed N5 Quiz</div>
                        <div class="quiz-type-desc">Kanji + Words mixed</div>
                        <div class="quiz-type-format">Random N5 content</div>
                    </button>
                </div>
            </div>
            
            <div class="guest-upgrade-section">
                <h3>üöÄ Want More?</h3>
                <p>Create an account to access all JLPT levels, save your progress, and create custom quizzes!</p>
                <button class="quiz-btn primary" onclick="showLoginScreen()">Create Account</button>
            </div>
            
            <div class="quiz-actions">
                <button class="quiz-btn secondary" onclick="showKanji()">Back to Dictionary</button>
            </div>
        </div>
    `;
}

function startGuestQuiz(quizType) {
    const content = document.getElementById('content');
    content.className = '';
    
    content.innerHTML = `
        <div class="quiz-setup">
            <h2>üß† ${quizType === 'kanji' ? 'N5 Kanji' : quizType === 'words' ? 'N5 Word' : 'Mixed N5'} Demo Quiz</h2>
            
            <div class="quiz-options">
                <label for="guestQuizCount">How many questions? (Demo limited to 5)</label>
                <input type="number" id="guestQuizCount" min="1" max="5" value="5" readonly>
                <small>Guest demo limited to 5 questions</small>
            </div>
            
            <div class="quiz-actions">
                <button class="quiz-btn primary" onclick="startGuestQuizWithType('${quizType}')">Start Demo Quiz</button>
                <button class="quiz-btn secondary" onclick="showQuiz()">Back to Quiz Options</button>
            </div>
        </div>
    `;
}

function startGuestQuizWithType(quizType) {

    currentQuizType = quizType === 'words' ? 'word' : quizType;
    currentQuestionIndex = 0;
    quizResults = [];
    hasAnswered = false;
    
    const content = document.getElementById('content');
    content.innerHTML = '<div class="loading">Preparing demo quiz...</div>';
    
    // Load N5 content only for guests
    Promise.all([
        fetch('/api/kanji').then(response => response.json()), // Will return N5 only for guests
        fetch('/api/words').then(response => response.json())  // Will return N5 only for guests
    ]).then(([kanjiData, wordsData]) => {
        
        let selectedItems = [];
        if (quizType === 'kanji') {
            selectedItems = kanjiData.map(item => ({...item, item_type: 'kanji'}));
        } else if (quizType === 'words') {
            selectedItems = wordsData.map(item => ({...item, item_type: 'word'}));
        } else { // mixed
            const kanjiItems = kanjiData.map(item => ({...item, item_type: 'kanji'}));
            const wordItems = wordsData.map(item => ({...item, item_type: 'word'}));
            selectedItems = [...kanjiItems, ...wordItems];
        }
        
        // Shuffle and take 5 items for demo
        const shuffledItems = shuffleArray(selectedItems);
        quizData = shuffledItems.slice(0, 5);
        
        // Store all items for generating wrong answers
        window.allKanjiForAnswers = kanjiData;
        window.allWordsForAnswers = wordsData;
        
        showQuestion();
    }).catch(error => {
        content.innerHTML = '<div class="error">Error loading demo quiz: ' + error.message + '</div>';
    });
}

// Update setupQuizType to ensure proper layout
function setupQuizType(quizType, maxItems) {
    const content = document.getElementById('content');
    // Ensure no grid layout
    content.className = '';
    
    content.innerHTML = `
        <div class="quiz-setup">
            <h2>üß† ${quizType === 'kanji' ? 'Kanji' : quizType === 'words' ? 'Word' : 'Mixed'} Quiz Setup</h2>
            
            <div class="quiz-options">
                <label for="quizCount">How many questions?</label>
                <input type="number" id="quizCount" min="1" max="${maxItems}" value="${Math.min(10, maxItems)}">
                <small>Maximum: ${maxItems}</small>
            </div>
            
            <div class="quiz-actions">
                <button class="quiz-btn primary" onclick="startQuizWithType('${quizType}', ${maxItems})">Start ${quizType === 'mixed' ? 'Mixed' : quizType === 'kanji' ? 'Kanji' : 'Word'} Quiz</button>
                <button class="quiz-btn secondary" onclick="showQuiz()">Back to Quiz Types</button>
            </div>
        </div>
    `;
}

function startQuizWithType(quizType, maxQuestions) {

    currentQuizType = quizType === 'words' ? 'word' : quizType;
    
    const quizCount = parseInt(document.getElementById('quizCount').value);
    
    if (quizCount < 1 || quizCount > maxQuestions) {
        alert(`Please enter a number between 1 and ${maxQuestions}`);
        return;
    }
    
    currentQuestionIndex = 0;
    quizResults = [];
    hasAnswered = false;
    
    const content = document.getElementById('content');
    content.innerHTML = '<div class="loading">Preparing quiz...</div>';
    
    // Load ALL items (not just selected) for wrong answers
    Promise.all([
        loadUserQuizItems('kanji'),
        loadUserQuizItems('word'),
        fetch('/api/kanji').then(response => response.json()), // All kanji for wrong answers
        fetch('/api/words').then(response => response.json())  // All words for wrong answers
    ]).then(([selectedKanji, selectedWords, allKanji, allWords]) => {
        
        let selectedItems = [];
        if (quizType === 'kanji') {
            selectedItems = selectedKanji;
        } else if (quizType === 'words') {
            selectedItems = selectedWords;
        } else { // mixed
            selectedItems = [...selectedKanji, ...selectedWords];
        }
        
        const shuffledItems = shuffleArray(selectedItems);
        quizData = shuffledItems.slice(0, quizCount);
        
        // Store all items for generating wrong answers
        window.allKanjiForAnswers = allKanji;
        window.allWordsForAnswers = allWords;
        
        showQuestion();
    });
}


function saveQuizSession() {
    if (!isAuthenticated) return; // Skip for guests
    
    const sessionData = {
        userId: getCurrentUserId(),
        sessionType: currentQuizType,
        totalQuestions: quizData.length,
        correctAnswers: quizResults.filter(r => r.isCorrect).length,
        sessionDuration: Math.round((quizEndTime - quizStartTime) / 1000), // Convert to seconds
        questionDetails: quizResults.map(result => ({
            itemType: result.itemType,
            itemId: result.itemId,
            wasCorrect: result.isCorrect,
            userAnswer: result.userAnswer,
            timeTaken: result.timeTaken || null
        }))
    };

    console.log('üêõ Session data being sent:', sessionData);
    console.log('üêõ First question detail:', sessionData.questionDetails[0]);
    
    fetch('/api/save-quiz-session', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(sessionData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('‚úÖ Quiz session saved successfully');
        } else {
            console.error('‚ùå Failed to save quiz session:', data.error);
        }
    })
    .catch(error => {
        console.error('‚ùå Error saving quiz session:', error);
    });
}

function showQuestion() {

    if (currentQuestionIndex === 0) {
    quizStartTime = Date.now();
    }

    window.currentQuestionStartTime = Date.now();
    
    if (currentQuestionIndex >= quizData.length) {
        showQuizComplete();
        return;
    }
    
    const item = quizData[currentQuestionIndex];
    currentQuestion = item;
    hasAnswered = false;
    
    if (item.item_type === 'kanji') {
        showKanjiQuestion(item);
    } else {
        showWordQuestion(item);
    }
}

function showKanjiQuestion(kanji) {
    const wrongAnswers = [];
    const allKanji = window.allKanjiForAnswers || [];
    
    // Get random wrong answers from ALL kanji (not just selected ones)
    const otherKanji = allKanji.filter(item => item.id !== kanji.id);
    const shuffledOtherKanji = shuffleArray(otherKanji);
    
    // Take first 4 random kanji for wrong answers
    for (let i = 0; i < Math.min(4, shuffledOtherKanji.length); i++) {
        const item = shuffledOtherKanji[i];
        
        // Create formatted answer with meaning and readings
        const onyomiPart = item.onyomi ? ` ‚Ä¢ On: ${item.onyomi}` : '';
        const kunyomiPart = item.kunyomi ? ` ‚Ä¢ Kun: ${item.kunyomi}` : '';
        const wrongAnswer = `<strong>${item.meaning}</strong>${onyomiPart}${kunyomiPart}`;
        
        wrongAnswers.push(wrongAnswer);
    }
    
    // Create correct answer with meaning and readings
    const onyomiPart = kanji.onyomi ? ` ‚Ä¢ On: ${kanji.onyomi}` : '';
    const kunyomiPart = kanji.kunyomi ? ` ‚Ä¢ Kun: ${kanji.kunyomi}` : '';
    const correctAnswer = `<strong>${kanji.meaning}</strong>${onyomiPart}${kunyomiPart}`;
    
    const allAnswers = [correctAnswer, ...wrongAnswers];
    const shuffledAnswers = shuffleArray(allAnswers);
    
    displayQuestion(
        `What does this kanji mean?`,
        kanji.kanji_char,
        shuffledAnswers,
        correctAnswer,
        'meaning'
    );
}

function showWordQuestion(word) {
    const wrongAnswers = [];
    const allWords = window.allWordsForAnswers || [];
    
    // Get random wrong answers from ALL words (not just selected ones)
    const otherWords = allWords.filter(item => item.id !== word.id);
    const shuffledOtherWords = shuffleArray(otherWords);
    
    // Take first 4 random words for wrong answers
    for (let i = 0; i < Math.min(4, shuffledOtherWords.length); i++) {
        wrongAnswers.push(shuffledOtherWords[i].meaning);
    }
    
    const correctAnswer = word.meaning;
    const allAnswers = [correctAnswer, ...wrongAnswers];
    const shuffledAnswers = shuffleArray(allAnswers);
    
    displayQuestion(
        `What does this word mean?`,
        `${word.word} (${word.reading || 'N/A'})`,
        shuffledAnswers,
        correctAnswer,
        'meaning'
    );
}

// Update displayQuestion to ensure proper layout
function displayQuestion(questionText, displayItem, answers, correctAnswer, questionType) {
    const content = document.getElementById('content');
    // Ensure no grid layout
    content.className = '';
    
    const answersHtml = answers.map((answer, index) => `
        <button class="answer-btn" onclick="selectAnswer('${answer.replace(/'/g, "\\'")}', '${correctAnswer.replace(/'/g, "\\'")}', ${index})" id="answer-${index}">
            ${answer}
        </button>
    `).join('');
    
    content.innerHTML = `
        <div class="quiz-question">
            <div class="quiz-progress">
                Question ${currentQuestionIndex + 1} of ${quizData.length}
            </div>
            
            <div class="question-card">
                <h3>${questionText}</h3>
                <div class="question-item">${displayItem}</div>
                
                <div class="answers">
                    ${answersHtml}
                </div>
                
                <div class="quiz-feedback" id="feedback" style="display: none;"></div>
                
                <div class="quiz-controls" id="controls" style="display: none;">
                    <button class="quiz-btn primary" onclick="nextQuestion()">Next Question</button>
                    <button class="quiz-btn secondary" onclick="quitQuiz()">Quit Quiz</button>
                </div>
            </div>
        </div>
    `;
}

function addToFocusList(itemType, itemId) {
    const userId = getCurrentUserId();
    
    fetch('/api/focus-list', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            userId: userId,
            itemType: itemType,
            itemId: itemId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('‚úÖ Added to focus list:', itemType, itemId);
        } else if (data.error !== 'Item already in focus list') {
            console.error('‚ùå Failed to add to focus list:', data.error);
        }
        // Silently ignore "already exists" errors
    })
    .catch(error => {
        console.error('‚ùå Error adding to focus list:', error);
    });
}

function selectAnswer(selectedAnswer, correctAnswer, selectedIndex) {
    if (hasAnswered) return;
    
    hasAnswered = true;
    const isCorrect = selectedAnswer === correctAnswer;

    const questionEndTime = Date.now();
    const questionStartTime = window.currentQuestionStartTime || questionEndTime;
    const timeTaken = Math.round((questionEndTime - questionStartTime) / 1000); // seconds
    
    
    // Store result locally for scoring
    quizResults.push({ 
        isCorrect: isCorrect,
        itemType: currentQuestion.item_type,
        itemId: currentQuestion.id,
        userAnswer: selectedAnswer,
        correctAnswer: correctAnswer,
        timeTaken: timeTaken
    });
    
    // Save to database
    saveQuizResult(currentQuestion, isCorrect, selectedAnswer);

    if (!isCorrect && isAuthenticated) {
        addToFocusList(currentQuestion.item_type, currentQuestion.id);
    }
    
    const feedback = document.getElementById('feedback');
    const controls = document.getElementById('controls');
    
    feedback.style.display = 'block';
    controls.style.display = 'block';
    
    const answerButtons = document.querySelectorAll('.answer-btn');
    answerButtons.forEach((btn, index) => {
        btn.disabled = true;
        if (btn.textContent === correctAnswer) {
            btn.classList.add('correct');
        } else if (index === selectedIndex && !isCorrect) {
            btn.classList.add('incorrect');
        }
    });
    
    if (isCorrect) {
        feedback.innerHTML = '<div class="feedback-correct">‚úì Correct!</div>';
    } else {
        feedback.innerHTML = `<div class="feedback-incorrect">‚úó Incorrect. The correct answer is: ${correctAnswer}</div>`;
    }
}

function saveQuizResult(item, isCorrect, userAnswer) {
    // Skip database saving for guests
    if (!isAuthenticated) {
        console.log('üë§ Guest mode: Quiz result not saved to database');
        return;
    }
    
    // Existing logic for authenticated users
    const userId = getCurrentUserId();
    
    fetch('/api/quiz-result', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            userId: userId,
            itemType: item.item_type,
            itemId: item.id,
            questionType: 'meaning',
            isCorrect: isCorrect,
            userAnswer: userAnswer
        })
    }).catch(error => {
        console.error('Error saving quiz result:', error);
    });
}

function nextQuestion() {
    currentQuestionIndex++;
    showQuestion();
}

function quitQuiz() {
    if (confirm('Are you sure you want to quit the quiz? Your progress will be saved.')) {
        showQuizComplete();
    }
}

function showQuizComplete() {

    quizEndTime = Date.now();
    saveQuizSession();   
    
    const correctCount = quizResults.filter(result => result.isCorrect).length;
    const totalQuestions = quizResults.length;
    const percentage = totalQuestions > 0 ? Math.round((correctCount / totalQuestions) * 100) : 0;
    
    const content = document.getElementById('content');
    content.className = '';
    
    if (!isAuthenticated) {
        // Guest completion screen with upgrade encouragement
        content.innerHTML = `
            <div class="quiz-complete">
                <h2>üéâ Demo Quiz Complete!</h2>
                <div class="quiz-score">
                    <div class="score-big">${correctCount}/${totalQuestions}</div>
                    <div class="score-percentage">${percentage}%</div>
                </div>
                
                <div class="guest-completion-notice">
                    <h3>üöÄ Liked the quiz system?</h3>
                    <p><strong>Create an account to unlock:</strong></p>
                    <ul>
                        <li>‚úÖ All JLPT levels (N5-N1)</li>
                        <li>‚úÖ Progress tracking & statistics</li>
                        <li>‚úÖ Custom word selection</li>
                        <li>‚úÖ Unlimited quiz length</li>
                        <li>‚úÖ Performance analytics</li>
                    </ul>
                </div>
                
                <div class="quiz-actions">
                    <button class="quiz-btn primary" onclick="showLoginScreen()">Create Account - Unlock Full Features</button>
                    <button class="quiz-btn secondary" onclick="showQuiz()">Try Another Demo Quiz</button>
                </div>
            </div>
        `;
    } else {
        // Existing authenticated user completion screen
        content.innerHTML = `
            <div class="quiz-complete">
                <h2>üéâ Quiz Complete!</h2>
                <div class="quiz-score">
                    <div class="score-big">${correctCount}/${totalQuestions}</div>
                    <div class="score-percentage">${percentage}%</div>
                </div>
                <div class="quiz-actions">
                    <button class="quiz-btn primary" onclick="showQuiz()">Take Another Quiz</button>
                    <button class="quiz-btn secondary" onclick="showKanji()">Back to Dictionary</button>
                </div>
            </div>
        `;
    }
}

function displayKanji(kanjiList) {
    
    console.log('üêõ displayKanji called with', kanjiList.length, 'items');
    console.log('üêõ First kanji item:', kanjiList[0]);
    
    const content = document.getElementById('content');
    console.log('üêõ content element found:', !!content);
    
    if (kanjiList.length === 0) {
        console.log('üêõ No kanji found, showing error');
        content.innerHTML = '<div class="error">No kanji found</div>';
        return;
    }
    
    if (kanjiList.length === 0) {
        content.innerHTML = '<div class="error">No kanji found</div>';
        return;
    }
    
    const userId = getCurrentUserId();
    
    // Create HTML for all kanji first
    const html = kanjiList.map(kanji => {
        const isSelected = isAuthenticated ? userSelections.has(kanji.id) : false;
        return `
        <div class="kanji-card">
            <div class="kanji-char">${kanji.kanji_char}</div>
            <div class="kanji-meaning">${kanji.meaning}</div>
            <div class="reading-section">
                <span class="reading-label">On'yomi:</span> 
                <span class="reading-value">${kanji.onyomi || 'N/A'}</span>
            </div>
            <div class="reading-section">
                <span class="reading-label">Kun'yomi:</span> 
                <span class="reading-value">${kanji.kunyomi || 'N/A'}</span>
            </div>
            <div class="reading-section">
                <span class="reading-label">Frequency:</span> 
                <span class="reading-value">${kanji.frequency_rank || 'N/A'}</span>
            </div>
            ${isAuthenticated ? `
            <div class="stats-section" id="stats-kanji-${kanji.id}">
                <span class="stats-loading">Loading stats...</span>
            </div>
            ` : '<div class="guest-stats">Login to see quiz statistics</div>'}
            <span class="jlpt-level">${kanji.jlpt_level || 'No JLPT'}</span>
            ${isAuthenticated ? `
            <button class="toggle-btn ${isSelected ? 'selected' : ''}" 
                    data-item-id="${kanji.id}" 
                    onclick="toggleSelection(${kanji.id})">
                ${isSelected ? '‚úì Selected' : '+ Add to Quiz'}
            </button>
            <button class="focus-btn" 
                    id="focus-kanji-${kanji.id}"
                    onclick="toggleFocusList('kanji', ${kanji.id})">
                üéØ Focus
            </button>
            ` : '<div class="guest-notice">Login to add to quiz</div>'}
        </div>
        `;
    }).join('');
    
    content.innerHTML = html;
    
    // Load statistics for each kanji only if authenticated
    if (isAuthenticated && userId) {
        kanjiList.forEach(kanji => {
            loadItemStats(userId, 'kanji', kanji.id);
            loadFocusStatus('kanji', kanji.id);
        });
    }
}

function displayWords(wordList) {
    const content = document.getElementById('content');
    
    if (wordList.length === 0) {
        content.innerHTML = '<div class="error">No words found</div>';
        return;
    }
    
    const userId = getCurrentUserId();
    
    const html = wordList.map(word => {
        const isSelected = isAuthenticated ? userSelections.has(word.id) : false;
        return `
        <div class="word-card">
            <div class="word-text">${word.word}</div>
            <div class="word-reading">${word.reading || 'N/A'}</div>
            <div class="word-meaning">${word.meaning}</div>
            <div class="reading-section">
                <span class="reading-label">Frequency:</span> 
                <span class="reading-value">${word.frequency_rank || 'N/A'}</span>
            </div>
            ${isAuthenticated ? `
            <div class="stats-section" id="stats-word-${word.id}">
                <span class="stats-loading">Loading stats...</span>
            </div>
            ` : '<div class="guest-stats">Login to see quiz statistics</div>'}
            <span class="jlpt-level">${word.jlpt_level || 'No JLPT'}</span>
            ${isAuthenticated ? `
            <button class="toggle-btn ${isSelected ? 'selected' : ''}" 
                    data-item-id="${word.id}" 
                    onclick="toggleSelection(${word.id})">
                ${isSelected ? '‚úì Selected' : '+ Add to Quiz'}
            </button>
            <button class="focus-btn" 
                    id="focus-word-${word.id}"
                    onclick="toggleFocusList('word', ${word.id})">
                üéØ Focus
            </button>
            ` : '<div class="guest-notice">Login to add to quiz</div>'}
        </div>
        `;
    }).join('');
    
    content.innerHTML = html;
    
    // Load statistics for each word only if authenticated
    if (isAuthenticated && userId) {
        wordList.forEach(word => {
            loadItemStats(userId, 'word', word.id);
            loadFocusStatus('word', word.id);
        });
    }
}

function loadItemStats(userId, itemType, itemId) {
    fetch(`/api/item-stats/${userId}/${itemType}/${itemId}`)
        .then(response => response.json())
        .then(stats => {
            const statsElement = document.getElementById(`stats-${itemType}-${itemId}`);
            if (statsElement) {
                if (stats.total_attempts > 0) {
                    const successClass = stats.success_rate >= 80 ? 'stats-excellent' : 
                                       stats.success_rate >= 60 ? 'stats-good' : 'stats-needs-work';
                    
                    statsElement.innerHTML = `
                        <div class="item-stats ${successClass}">
                            <span class="stats-label">Quiz Stats:</span>
                            <span class="stats-correct">‚úì ${stats.correct_count}</span>
                            <span class="stats-wrong">‚úó ${stats.wrong_count}</span>
                            <span class="stats-rate">(${stats.success_rate}%)</span>
                        </div>
                    `;
                } else {
                    statsElement.innerHTML = `
                        <div class="item-stats stats-none">
                            <span class="stats-label">Quiz Stats:</span>
                            <span class="stats-not-studied">Not studied yet</span>
                        </div>
                    `;
                }
            }
        })
        .catch(error => {
            console.error('Error loading stats:', error);
            const statsElement = document.getElementById(`stats-${itemType}-${itemId}`);
            if (statsElement) {
                statsElement.innerHTML = '<span class="stats-error">Stats unavailable</span>';
            }
        });
}


function toggleFocusList(itemType, itemId) {
    const userId = getCurrentUserId();
    const button = document.getElementById(`focus-${itemType}-${itemId}`);
    const isInFocus = button.classList.contains('in-focus');
    
    const method = isInFocus ? 'DELETE' : 'POST';
    const url = isInFocus ? `/api/focus-list/${userId}/${itemType}/${itemId}` : '/api/focus-list';
    
    const requestBody = method === 'POST' ? {
        userId: userId,
        itemType: itemType,
        itemId: itemId
    } : {};
    
    fetch(url, {
        method: method,
        headers: { 'Content-Type': 'application/json' },
        body: method === 'POST' ? JSON.stringify(requestBody) : undefined
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateFocusButton(itemType, itemId, !isInFocus);
        } else {
            console.error('Failed to update focus list:', data.error);
        }
    })
    .catch(error => {
        console.error('Error updating focus list:', error);
    });
}

// Load focus status for an item
function loadFocusStatus(itemType, itemId) {
    const userId = getCurrentUserId();
    
    fetch(`/api/focus-list/${userId}/${itemType}/${itemId}`)
        .then(response => response.json())
        .then(data => {
            updateFocusButton(itemType, itemId, data.inFocus);
        })
        .catch(error => {
            console.error('Error loading focus status:', error);
        });
}

// Update focus button appearance
function updateFocusButton(itemType, itemId, isInFocus) {
    const button = document.getElementById(`focus-${itemType}-${itemId}`);
    if (button) {
        if (isInFocus) {
            button.classList.add('in-focus');
            button.textContent = 'üéØ Focused';
        } else {
            button.classList.remove('in-focus');
            button.textContent = 'üéØ Focus';
        }
    }
}

function searchItems() {
    const searchTerm = document.getElementById('searchInput').value.trim();
    
    if (!searchTerm) {
        showAll();
        return;
    }
    
    const content = document.getElementById('content');
    content.innerHTML = '<div class="loading">Searching...</div>';
    
    const endpoint = currentView === 'kanji' ? '/api/kanji/search' : '/api/words/search';
    
    // Get the current JLPT filter value correctly
    const jlptFilterElement = document.getElementById('jlptSelect');
    const jlptFilter = jlptFilterElement ? jlptFilterElement.value : '';
    
    // Build query parameters
    let queryParams = `q=${encodeURIComponent(searchTerm)}`;
    if (jlptFilter && jlptFilter !== '') {
        queryParams += `&jlpt=${encodeURIComponent(jlptFilter)}`;
    }
    
    // DEBUG: Log what we're sending
    console.log('üîç Search Debug:', {
        searchTerm: searchTerm,
        jlptFilter: jlptFilter,
        isGuest: !isAuthenticated,
        fullURL: `${endpoint}?${queryParams}`
    });
    
    fetch(`${endpoint}?${queryParams}`)
        .then(response => {
            console.log('üì° Search response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('üìä Search results received:', data.length, 'items');
            
            // ‚úÖ DEBUG: Show first few results for verification
            if (data.length > 0) {
                console.log('üîç Sample results:', data.slice(0, 3).map(item => ({
                    item: item.kanji_char || item.word,
                    jlpt_level: item.jlpt_level
                })));
            }
            
            totalItems = data;
            filteredItems = data;
            currentPage = 1;
            displayPaginatedItems();
        })
        .catch(error => {
            console.error('‚ùå Search error:', error);
            content.innerHTML = '<div class="error">Search error: ' + error.message + '</div>';
        });
}

function showProfile() {
    currentView = 'profile';
    updateNavButtons('profile');
    
    // Hide all filters on Profile page
    document.getElementById('jlptFilter').style.display = 'none';
    document.getElementById('sortFilter').style.display = 'none';
    if (document.getElementById('quizFilter')) {
        document.getElementById('quizFilter').parentElement.style.display = 'none';
    }
    document.getElementById('pagination').style.display = 'none';
    document.querySelector('.search-box').style.display = 'none';
    
    // Remove grid layout for profile page
    document.getElementById('content').className = '';
    
    
    const content = document.getElementById('content');
    content.innerHTML = '<div class="loading">Loading your profile...</div>';
    
    // Load user stats
    const userId = getCurrentUserId();
    Promise.all([
        fetch(`/api/user-stats/${userId}`).then(response => response.json()),
        fetch(`/api/user-stats-by-jlpt/${userId}/kanji`).then(response => response.json()),
        fetch(`/api/user-stats-by-jlpt/${userId}/word`).then(response => response.json()),
        fetch(`/api/recent-performance/${userId}`).then(response => response.json())
    ]).then(([overallStats, kanjiByJLPT, wordsByJLPT, recentPerformance]) => {
        displayProfile(overallStats, kanjiByJLPT, wordsByJLPT, recentPerformance);
    }).catch(error => {
        console.error('Error loading profile data:', error);
        content.innerHTML = `
            <div class="error">
                <h3>Error loading profile</h3>
                <p>Error: ${error.message}</p>
                <button onclick="showProfile()" class="quiz-btn primary">Try Again</button>
            </div>
        `;
    });
}

function displayProfile(overallStats, kanjiByJLPT, wordsByJLPT, recentPerformance) {
    const content = document.getElementById('content');

    const totalKanjiAttempts = parseInt(overallStats.kanji.total_attempts) || 0;
    const totalWordAttempts = parseInt(overallStats.words.total_attempts) || 0;
    const totalAttempts = totalKanjiAttempts + totalWordAttempts;
    const totalKanjiCorrect = parseInt(overallStats.kanji.correct_count) || 0;
    const totalWordCorrect = parseInt(overallStats.words.correct_count) || 0;
    const totalCorrect = totalKanjiCorrect + totalWordCorrect;
    const overallSuccessRate = totalAttempts > 0 ? Math.round((totalCorrect / totalAttempts) * 100) : 0;
    
    // Get performance class
    const getPerformanceClass = (rate) => {
        if (rate >= 80) return 'stats-excellent';
        if (rate >= 60) return 'stats-good';
        return 'stats-needs-work';
    };
    
    // DEBUG: Log the calculation for verification
    console.log('üìä Performance Calculation Debug:');
    console.log('Kanji Correct (raw):', overallStats.kanji.correct_count, 'Type:', typeof overallStats.kanji.correct_count);
    console.log('Word Correct (raw):', overallStats.words.correct_count, 'Type:', typeof overallStats.words.correct_count);
    console.log('Total Kanji Correct (parsed):', totalKanjiCorrect);
    console.log('Total Word Correct (parsed):', totalWordCorrect);
    console.log('Total Correct:', totalCorrect);
    console.log('Total Kanji Attempts:', totalKanjiAttempts);
    console.log('Total Word Attempts:', totalWordAttempts);
    console.log('Total Attempts:', totalAttempts);
    console.log('Calculated Success Rate:', overallSuccessRate + '%');
    
    content.innerHTML = `
        <div class="profile-page">
            <h2>üë§ Your Profile</h2>
            
            <div class="profile-header">
                <div class="profile-info">
                    <h3>Welcome back, ${currentUser.username}! üëã</h3>
                    <p class="profile-subtitle">Here's your Japanese learning progress</p>
                </div>
            </div>

            <div class="profile-actions">
                <button class="quiz-btn primary" onclick="showQuiz()">Take a Quiz</button>
                <button class="quiz-btn secondary" onclick="showKanji()">Study Kanji</button>
                <button class="quiz-btn secondary" onclick="showWords()">Study Words</button>
              <button class="quiz-btn focus-list-btn" onclick="showFocusListModal()">üéØ View Focus List</button>
            </div>
            
            <div class="stats-overview">
                <div class="stats-card">
                    <h3>üìä Overall Performance</h3>
                    <div class="stats-number ${getPerformanceClass(overallSuccessRate)}">${overallSuccessRate}%</div>
                    <div class="stats-detail">${totalCorrect} correct out of ${totalAttempts} total questions</div>
                    <div class="stats-detail">Across both kanji and vocabulary</div>
                </div>
                
                <div class="stats-card">
                    <h3>üìù Kanji Progress</h3>
                    <div class="stats-number ${getPerformanceClass(parseInt(overallStats.kanji.success_rate) || 0)}">${overallStats.kanji.success_rate || 0}%</div>
                    <div class="stats-detail">${totalKanjiCorrect} correct out of ${totalKanjiAttempts} attempts</div>
                    <div class="stats-detail">${parseInt(overallStats.kanji.unique_items_studied) || 0} unique kanji studied</div>
                </div>
                
                <div class="stats-card">
                    <h3>üí¨ Vocabulary Progress</h3>
                    <div class="stats-number ${getPerformanceClass(parseInt(overallStats.words.success_rate) || 0)}">${overallStats.words.success_rate || 0}%</div>
                    <div class="stats-detail">${totalWordCorrect} correct out of ${totalWordAttempts} attempts</div>
                    <div class="stats-detail">${parseInt(overallStats.words.unique_items_studied) || 0} unique words studied</div>
                </div>
            </div>
            
            ${kanjiByJLPT.length > 0 || wordsByJLPT.length > 0 ? `
            <div class="jlpt-breakdown">
                <h3>üéå JLPT Level Breakdown</h3>
                <div class="jlpt-stats">
                    ${kanjiByJLPT.map(level => `
                        <div class="jlpt-stat-card">
                            <div class="jlpt-level-label kanji-label">${level.jlpt_level || 'No Level'} Kanji</div>
                            <div class="jlpt-stat-number">${level.success_rate || 0}%</div>
                            <div class="jlpt-stat-detail">${level.total_attempts} attempts</div>
                            <div class="jlpt-stat-detail">${level.unique_items_studied} unique</div>
                        </div>
                    `).join('')}
                    ${wordsByJLPT.map(level => `
                        <div class="jlpt-stat-card">
                            <div class="jlpt-level-label words-label">${level.jlpt_level || 'No Level'} Words</div>
                            <div class="jlpt-stat-number">${level.success_rate || 0}%</div>
                            <div class="jlpt-stat-detail">${level.total_attempts} attempts</div>
                            <div class="jlpt-stat-detail">${level.unique_items_studied} unique</div>
                        </div>
                    `).join('')}
                </div>
            </div>
            ` : ''}
            
            ${recentPerformance.length > 0 ? `
            <div class="recent-activity">
                <h3>üìÖ Recent Activity (Last 30 Days)</h3>
                <div class="activity-list">
                    ${recentPerformance.slice(0, 10).map(day => `
                        <div class="activity-item">
                            <div class="activity-date">${new Date(day.quiz_date).toLocaleDateString()}</div>
                            <div class="activity-type">${day.item_type === 'kanji' ? 'üìù Kanji' : 'üí¨ Words'}</div>
                            <div class="activity-stats">
                                ${day.correct_count}/${day.total_attempts} (${day.success_rate}%)
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
            ` : `
            <div class="recent-activity">
                <h3>üìÖ Recent Activity</h3>
                <div class="no-activity">
                    <p>No quiz activity yet! Start studying to see your progress here.</p>
                    <button class="quiz-btn primary" onclick="showKanji()">Start Learning</button>
                </div>
            </div>
            `}
        </div>
    `;
}

function displayFocusListItems(items) {
    const contentDiv = document.getElementById('focusListContent');
    
    if (items.length === 0) {
        contentDiv.innerHTML = `
            <div class="no-focus-items">
                <h3>üéØ No Focus Items Yet</h3>
                <p>Items you get wrong in quizzes will automatically be added here.</p>
                <p>You can also manually add items using the "üéØ Focus" button on kanji/word cards.</p>
                <button class="quiz-btn primary" onclick="closeFocusListModal(); showQuiz();">
                    Take a Quiz
                </button>
            </div>
        `;
        return;
    }
    
    // Separate kanji and words
    const kanjiItems = items.filter(item => item.item_type === 'kanji');
    const wordItems = items.filter(item => item.item_type === 'word');
    
    let html = `
        <div class="focus-list-stats">
            <div class="focus-stat">
                <span class="focus-stat-number">${items.length}</span>
                <span class="focus-stat-label">Total Items</span>
            </div>
            <div class="focus-stat">
                <span class="focus-stat-number">${kanjiItems.length}</span>
                <span class="focus-stat-label">Kanji</span>
            </div>
            <div class="focus-stat">
                <span class="focus-stat-number">${wordItems.length}</span>
                <span class="focus-stat-label">Words</span>
            </div>
        </div>
    `;
    
    if (kanjiItems.length > 0) {
        html += `
            <div class="focus-section">
                <h3>üìù Kanji (${kanjiItems.length})</h3>
                <div class="focus-items-grid">
                    ${kanjiItems.map(item => `
                        <div class="focus-item">
                            <div class="focus-item-char">${item.kanji_char}</div>
                            <div class="focus-item-meaning">${item.meaning}</div>
                            <button class="remove-focus-btn" onclick="removeFocusItem('kanji', ${item.item_id})">
                                ‚úï
                            </button>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }
    
    if (wordItems.length > 0) {
        html += `
            <div class="focus-section">
                <h3>üí¨ Words (${wordItems.length})</h3>
                <div class="focus-items-grid">
                    ${wordItems.map(item => `
                        <div class="focus-item">
                            <div class="focus-item-word">${item.word}</div>
                            <div class="focus-item-reading">${item.reading || ''}</div>
                            <div class="focus-item-meaning">${item.meaning}</div>
                            <button class="remove-focus-btn" onclick="removeFocusItem('word', ${item.item_id})">
                                ‚úï
                            </button>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }
    
    html += `
        <div class="focus-actions">
            <button class="quiz-btn primary" onclick="startFocusQuiz()">
                üéØ Quiz Focus Items
            </button>
            <button class="quiz-btn secondary" onclick="closeFocusListModal()">
                Close
            </button>
        </div>
    `;
    
    contentDiv.innerHTML = html;
}

// Remove item from focus list (from modal)
function removeFocusItem(itemType, itemId) {
    const userId = getCurrentUserId();
    
    fetch(`/api/focus-list/${userId}/${itemType}/${itemId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadFocusListItems(); // Reload the list
        } else {
            alert('Failed to remove item from focus list');
        }
    })
    .catch(error => {
        console.error('Error removing from focus list:', error);
        alert('Error removing item from focus list');
    });
}

function showFocusListModal() {
    const userId = getCurrentUserId();
    
    // Create modal if it doesn't exist
    let modal = document.getElementById('focusListModal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'focusListModal';
        modal.className = 'modal';
        modal.innerHTML = `
            <div class="modal-content focus-modal-content">
                <span class="close" onclick="closeFocusListModal()">&times;</span>
                <div class="modal-header">
                    <h2>üéØ Your Focus List</h2>
                    <p>Items you need to review</p>
                </div>
                <div id="focusListContent">
                    <div class="loading">Loading focus list...</div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }
    
    modal.style.display = 'block';
    loadFocusListItems();
    
    // Close modal when clicking outside
    modal.onclick = function(event) {
        if (event.target === modal) {
            closeFocusListModal();
        }
    };
}

// Close focus list modal
function closeFocusListModal() {
    const modal = document.getElementById('focusListModal');
    if (modal) {
        modal.style.display = 'none';
    }
}

// Load and display focus list items
function loadFocusListItems() {
    const userId = getCurrentUserId();
    const contentDiv = document.getElementById('focusListContent');
    
    fetch(`/api/focus-list/${userId}`)
        .then(response => response.json())
        .then(data => {
            displayFocusListItems(data);
        })
        .catch(error => {
            console.error('Error loading focus list:', error);
            contentDiv.innerHTML = '<div class="error">Failed to load focus list</div>';
        });
}

// Start a quiz with only focus items
function startFocusQuiz() {
    // This will be implemented in the next step
    alert('Focus quiz coming soon!');
    closeFocusListModal();
}

function showAll() {
    document.getElementById('searchInput').value = '';
    //document.getElementById('jlptSelect').value = '';
    //document.getElementById('quizFilter').value = 'all';
    if (currentView === 'kanji') {
        loadKanji();
    } else {
        loadWords();
    }
}

function showAbout() {
    currentView = 'about';
    updateNavButtons('about');
    document.getElementById('jlptFilter').style.display = 'none';
    document.getElementById('sortFilter').style.display = 'none';
    if (document.getElementById('quizFilter')) {
        document.getElementById('quizFilter').parentElement.style.display = 'none';
    }
    document.getElementById('pagination').style.display = 'none';
    document.querySelector('.search-box').style.display = 'none';
    
    // Remove grid layout for about page
    document.getElementById('content').className = '';
    
    const content = document.getElementById('content');
    content.innerHTML = `
        <div class="about-page">
            <h2>üìö About Kanji Wizard</h2>
            
            <div class="about-section">
                <h3>üì¨ Contact & Feedback</h3>
                <p>We're continuously improving this app based on user feedback. If you have suggestions, find bugs, or just want to share your learning journey, we'd love to hear from you!</p>
                <p>Feel free to reach out with any questions or suggestions at <b>support@thekanjiwizard.com</b></p>
            </div>
                        
            <div class="about-section">
                <h3>üöÄ How to Use</h3>
                <p><strong>For Guests:</strong> Browse N5 kanji and vocabulary to get started with basic Japanese.</p>
                <p><strong>For Registered Users:</strong> Create an account to access all JLPT levels, save items for quiz study, and track your progress over time.</p>
            </div>

            <div class="about-section">
                <h3>üéØ Our Mission</h3>
                <p>We have applications like Duolingo or WaniKani who helps you learn at <b>THEIR</b> pace. </p> 
                <p>I've made this application for a customizable learning experience to learn at <b>YOUR</b> pace! <b>YOU</b> control <b>when and how</b> you want to learn. Kanji Wizard is designed to help students master kanji and vocabulary through interactive study and quiz features.</p>
            </div>
            
            <div class="about-section">
                <h3>‚ú® Features</h3>
                <ul>
                    <li><strong>Comprehensive Dictionary:</strong> Browse thousands of kanji and vocabulary words with readings, meanings, and JLPT classifications</li>
                    <li><strong>Interactive Quizzes:</strong> Test your knowledge with customizable quizzes for kanji and vocabulary</li>
                    <li><strong>Progress Tracking:</strong> Monitor your learning progress with detailed statistics</li>
                    <li><strong>JLPT Organization:</strong> Content organized by JLPT levels N5 through N1</li>
                    <li><strong>Guest Access:</strong> Try out N5 content without creating an account</li>
                </ul>
            </div>

            <div class="about-section">
                <h3>üìã Commercial Transaction Law Disclosure (ÁâπÂÆöÂïÜÂèñÂºïÊ≥ï„Å´Âü∫„Å•„ÅèË°®Ë®ò)</h3>
                <div style="line-height: 1.8;">
                    <p><strong>Service Name:</strong> Kanji Wizard (Êº¢Â≠ó„Ç¶„Ç£„Ç∂„Éº„Éâ)</p>
                    <p><strong>Operator:</strong> Akira Sonoda</p>
                    <p><strong>Business Type:</strong> Digital Learning Application Service</p>
                    <p><strong>Contact Email:</strong> support@thekanjiwizard.com</p>
                    <p><strong>Payment Email:</strong> payment@thekanjiwizard.com</p>
                    <p><strong>Business Address:</strong> Available upon request via email</p>
                    <p><strong>Phone Number:</strong> Available upon request via email</p>
                    <p><strong>Service Description:</strong> Lifetime access to Japanese language learning application with kanji and vocabulary study tools, quizzes, and progress tracking</p>
                    <p><strong>Price:</strong> $9.99 (approximately ¬•1,500) - one-time payment for lifetime access</p>
                    <p><strong>Payment Methods:</strong> Credit card, debit card via Stripe payment processor</p>
                    <p><strong>Additional Fees:</strong> None. All fees are included in the displayed price</p>
                    <p><strong>Delivery Method:</strong> Digital delivery via email with login credentials</p>
                    <p><strong>Delivery Time:</strong> Immediate to 5 minutes after payment confirmation</p>
                    <p><strong>Cancellation & Refund Policy:</strong><br>
                    ‚Ä¢ Cancellations accepted within 7 days of purchase for accidental purchases<br>
                    ‚Ä¢ Refunds processed within 5-10 business days<br>
                    ‚Ä¢ Contact payment@thekanjiwizard.com for refund requests<br>
                    ‚Ä¢ No cancellations after 7 days due to digital nature of service</p>
                    
                    <p><strong>Exchange Policy:</strong> Due to the digital nature of this service, exchanges are not applicable</p>
                    <p><strong>Technical Requirements:</strong> Internet connection and modern web browser required</p>
                    <p><strong>Customer Support:</strong> Email support available at support@thekanjiwizard.com</p>
                    <p><strong>Dispute Resolution:</strong> Disputes will be resolved according to Japanese law. For international customers, we will work to resolve issues fairly under applicable consumer protection standards.</p>
                </div>
            </div>
            
            <div class="about-actions">
                <button class="quiz-btn primary" onclick="showKanji()">Start Learning</button>
                <button class="quiz-btn secondary" onclick="showSources()">View Sources</button>
            </div>
        </div>
    `;
}

function showSources() {
    currentView = 'sources';
    updateNavButtons('sources');
    document.getElementById('jlptFilter').style.display = 'none';
   document.getElementById('sortFilter').style.display = 'none';
    if (document.getElementById('quizFilter')) {
        document.getElementById('quizFilter').parentElement.style.display = 'none';
    }

    document.getElementById('pagination').style.display = 'none';
    document.querySelector('.search-box').style.display = 'none';
    
    // Remove grid layout for sources page
    document.getElementById('content').className = '';
    
    const content = document.getElementById('content');
    content.innerHTML = `
        <div class="sources-page">
            <h2>üìñ Data Sources & Credits</h2>
            
            <div class="sources-section">
                <h3>üî§ Kanji Data</h3>
                <p>Our kanji database includes character information, readings (on'yomi and kun'yomi), meanings, and frequency rankings compiled from multiple educational sources:</p>
                <ul>
                    <li><strong>JLPT Classifications:</strong> Official Japanese Language Proficiency Test level assignments</li>
                    <li><strong>Frequency Rankings:</strong> Based on newspaper and modern text analysis</li>
                    <li><strong>Readings & Meanings:</strong> Standardized educational sources and dictionaries</li>
                </ul>
            </div>
            
            <div class="sources-section">
                <h3>üìù Vocabulary Data</h3>
                <p>Our vocabulary database contains Japanese words with readings, meanings, and grammatical information:</p>
                <ul>
                    <li><strong>JLPT Word Lists:</strong> Vocabulary organized by proficiency test levels</li>
                    <li><strong>Part of Speech:</strong> Grammatical classifications for proper usage</li>
                    <li><strong>Frequency Data:</strong> Common usage rankings in modern Japanese</li>
                </ul>
            </div>
            
            <div class="sources-section">
                <h3>üéì Educational Framework</h3>
                <p>The learning structure follows established Japanese language education principles:</p>
                <ul>
                    <li><strong>JLPT Standards:</strong> Aligned with official Japanese Language Proficiency Test curriculum</li>
                    <li><strong>Progressive Learning:</strong> Content organized from beginner (N5) to advanced (N1) levels</li>
                    <li><strong>Practical Application:</strong> Focus on commonly used characters and vocabulary</li>
                </ul>
            </div>
            
            <div class="sources-section">
                <h3>‚öñÔ∏è Usage & Attribution</h3>
                <p>This application uses publicly available educational data and follows fair use guidelines for educational purposes. All kanji and vocabulary data represents standardized information available in educational contexts.</p>
                <p>The application itself is created for educational use and to support Japanese language learners worldwide.</p>
                <p><b>Kanji List</b>: Github repository of davidluzgouveia </p>
                <p><b>Vocabulary List</b>: "JLPT vocabulary by level" by Robin Pourtaud in Kaggle.com </p>
            </div>
            
            <div class="sources-actions">
                <button class="quiz-btn primary" onclick="showAbout()">About This App</button>
                <button class="quiz-btn secondary" onclick="showKanji()">Back to Learning</button>
            </div>
        </div>
    `;
}

function showPricing() {
    currentView = 'pricing';
    updateNavButtons('pricing');
    
    // Hide all filters and search bar on Pricing page
    document.getElementById('jlptFilter').style.display = 'none';
    document.getElementById('sortFilter').style.display = 'none';
    if (document.getElementById('quizFilter')) {
        document.getElementById('quizFilter').parentElement.style.display = 'none';
    }
    document.querySelector('.search-box').style.display = 'none';
    document.getElementById('pagination').style.display = 'none';
    
    // Remove grid layout for pricing page
    document.getElementById('content').className = '';
    
    const content = document.getElementById('content');
    
    // Different content based on user status
    if (!isAuthenticated) {
        // Guest user - show full pricing page
        showGuestPricing(content);
    } else if (currentUser && currentUser.role == 'registered') {
        // Registered user - show upgrade page
        showRegisteredUpgrade(content);
    } else {
        // Paid user - show thank you message
        showPaidUserMessage(content);
    }
}

function showGuestPricing(content) {
    content.innerHTML = `
        <div class="pricing-page">
            <h2>üí∞ Unlock Your Japanese Learning</h2>
            
            <div class="pricing-hero">
                <h3>üöÄ Choose Your Learning Path</h3>
                <p>Start free or unlock everything with our affordable one-time payment!</p>
            </div>
            
            <!-- Free Account Option -->
            <div class="pricing-option free-option">
                <div class="pricing-header">
                    <h3>üÜì Free Account</h3>
                    <div class="price-display">
                        <span class="price-amount">Free</span>
                        <span class="price-period">forever</span>
                    </div>
                    <p class="price-subtitle">Perfect for beginners</p>
                </div>
                
                <div class="features-list">
                    <h4>‚ú® What You Get:</h4>
                    <ul>
                        <li>üìö <strong>N5 + N4 Content:</strong> 1,000+ kanji & vocabulary</li>
                        <li>üíæ <strong>Save Progress:</strong> Track your learning journey</li>
                        <li>üéØ <strong>Custom Quizzes:</strong> Select your study materials</li>
                        <li>üìä <strong>Basic Statistics:</strong> Monitor your progress</li>
                    </ul>
                </div>
                
                <div class="pricing-cta">
                    <button class="register-btn primary" onclick="showRegisterFromPricing()">
                        üÜì Create Free Account
                    </button>
                </div>
            </div>
            
            <!-- Full Access Option -->
            <div class="pricing-option paid-option featured">
                <div class="featured-badge">Most Popular</div>
                <div class="pricing-header">
                    <h3>üéå Full Access</h3>
                    <div class="price-display">
                        <s>$25.99</s><span class="price-amount">$9.99</span>
                        <span class="price-period">one-time payment</span>
                    </div>
                    <p class="price-subtitle">Lifetime access ‚Ä¢ No monthly fees</p>
                </div>
                
                <div class="features-list">
                    <h4>‚ú® Everything in Free, Plus:</h4>
                    <ul>
                        <li>üìö <strong>All JLPT Levels:</strong> N5, N4, N3, N2, N1 content</li>
                        <li>üîç <strong>Complete Dictionary:</strong> 6,000+ kanji & vocabulary</li>
                        <li>üìà <strong>Advanced Analytics:</strong> Detailed performance tracking</li>
                        <li>üé® <strong>Frequency Sorting:</strong> Study most common words first</li>
                        <li>‚ö° <strong>Premium Features:</strong> All future updates included</li>
                    </ul>
                </div>
                
                <div class="pricing-cta">
                    <button class="upgrade-btn primary" onclick="startDirectPurchase()">
                        üîê Register Free Account & Upgrade later
                    </button>
                    <p class="cta-subtitle">Instant access ‚Ä¢ Secure payment via Stripe</p>
                </div>
            </div>
            
            <div class="value-comparison">
                <h4>üí° Compare the Value:</h4>
                <div class="comparison-grid">
                    <div class="comparison-item">
                        <span class="competitor">WaniKani:</span>
                        <span class="competitor-price">$9/month = $108/year</span>
                    </div>
                    <div class="comparison-item">
                        <span class="competitor">Busuu:</span>
                        <span class="competitor-price">$8/month = $96/year</span>
                    </div>
                    <div class="comparison-item our-price">
                        <span class="competitor">Kanji Wizard:</span>
                        <s>$25.99</s><span class="competitor-price">$9.99 one-time = LIFETIME</span>
                    </div>
                </div>
            </div>
            
            <div class="pricing-actions">
                <button class="quiz-btn secondary" onclick="showQuiz()">Try Demo Quiz</button>
                <button class="quiz-btn secondary" onclick="showAbout()">Learn More</button>
            </div>
        </div>
    `;
}

function showRegisteredUpgrade(content) {
    content.innerHTML = `
        <div class="pricing-page">
            <h2>üöÄ Upgrade to Full Access</h2>
            
            <div class="upgrade-hero">
                <h3>Ready for the Next Level?</h3>
                <p>You've experienced N5 and N4 - now unlock N3, N2, and N1!</p>
            </div>
            
            <div class="pricing-card featured">
                <div class="pricing-header">
                    <h3>üéå Upgrade to Full Access</h3>
                    <div class="price-display">
                        <s>$25.99</s><span class="price-amount">$9.99</span>
                        <span class="price-period">one-time payment</span>
                    </div>
                    <p class="price-subtitle">Lifetime access ‚Ä¢ No monthly fees</p>
                </div>
                
                <div class="upgrade-comparison">
                    <div class="current-plan">
                        <h4>‚úÖ You Currently Have:</h4>
                        <ul>
                            <li>üìö N5 + N4 content access</li>
                            <li>üíæ Progress saving</li>
                            <li>üéØ Custom quiz creation</li>
                            <li>üìä Basic statistics</li>
                        </ul>
                    </div>
                    
                    <div class="upgrade-benefits">
                        <h4>üÜô Upgrade Unlocks:</h4>
                        <ul>
                            <li>üìö <strong>N3, N2, N1 Content:</strong> 5,000+ additional items</li>
                            <li>üìà <strong>Advanced Analytics:</strong> Detailed performance insights</li>
                            <li>üé® <strong>Frequency Sorting:</strong> Optimize your study order</li>
                            <li>‚ö° <strong>All Future Features:</strong> Lifetime updates included</li>
                        </ul>
                    </div>
                </div>
                
                <div class="pricing-form">
                    <h4>üõí Complete Your Upgrade</h4>
                    
                    <div class="user-info-display">
                        <p><strong>Upgrading Account:</strong> ${currentUser.username}</p>
                        <p><strong>Email:</strong> ${currentUser.email}</p>
                        <p><small>You'll keep your existing login credentials</small></p>
                    </div>
                    
                    <div class="pricing-cta">
                        <button class="upgrade-btn primary" onclick="startUpgradeProcess()" id="upgradeBtn">
                            üîê Upgrade Now - $9.99
                        </button>
                        <p class="cta-subtitle">Instant access ‚Ä¢ Secure payment via Stripe</p>
                        <p class="security-note">üîí Your payment is secure and encrypted</p>
                    </div>
                </div>
                
                <div class="money-back">
                    <p>üí∞ <strong>7-day satisfaction guarantee</strong> - Contact support if not satisfied</p>
                </div>
            </div>
            
            <div class="pricing-actions">
                <button class="quiz-btn secondary" onclick="showKanji()">Continue with Free Account</button>
                <button class="quiz-btn secondary" onclick="showAbout()">Learn More</button>
            </div>
        </div>
    `;
}

function showPaidUserMessage(content) {
    content.innerHTML = `
        <div class="pricing-page">
            <h2>üéâ You Have Full Access!</h2>
            
            <div class="paid-user-hero">
                <div class="success-icon">‚ú®</div>
                <h3>Thank You for Supporting Kanji Wizard!</h3>
                <p>You have lifetime access to all JLPT levels and features.</p>
            </div>
            
            <div class="access-summary">
                <h4>üéå Your Access Includes:</h4>
                <div class="access-grid">
                    <div class="access-item">
                        <div class="access-icon">üìö</div>
                        <div class="access-text">
                            <strong>All JLPT Levels</strong>
                            <p>N5, N4, N3, N2, N1 content</p>
                        </div>
                    </div>
                    <div class="access-item">
                        <div class="access-icon">üéØ</div>
                        <div class="access-text">
                            <strong>Unlimited Quizzes</strong>
                            <p>Custom study sessions</p>
                        </div>
                    </div>
                    <div class="access-item">
                        <div class="access-icon">üìä</div>
                        <div class="access-text">
                            <strong>Advanced Stats</strong>
                            <p>Detailed progress tracking</p>
                        </div>
                    </div>
                    <div class="access-item">
                        <div class="access-icon">‚ö°</div>
                        <div class="access-text">
                            <strong>Future Updates</strong>
                            <p>All new features included</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="coming-soon-preview">
                <h4>üöÄ Coming Soon for You:</h4>
                <ul>
                    <li>üéôÔ∏è Audio pronunciation guides</li>
                    <li>üí¨ Sentence examples in context</li>
                    <li>üì± Mobile app (iOS & Android)</li>
                    <li>üèÜ Achievement system</li>
                </ul>
            </div>
            
            <div class="pricing-actions">
                <button class="quiz-btn primary" onclick="showQuiz()">Start Learning</button>
                <button class="quiz-btn secondary" onclick="showProfile()">View Your Progress</button>
                <button class="quiz-btn secondary" onclick="showComingSoon()">See What's Coming</button>
            </div>
        </div>
    `;
}

function showRegisterFromPricing() {
    showLoginScreen();
    setTimeout(function() {
        showRegisterTab();
    }, 100);
}

function startDirectPurchase() {
    // Redirect to create account with payment flow
    showLoginScreen();
    setTimeout(function() {
        showRegisterTab();
        
        // Add notice about direct purchase
        const registerTab = document.getElementById('registerTab');
        if (registerTab) {
            const notice = document.createElement('div');
            notice.className = 'payment-notice';
            notice.innerHTML = '<p><strong>üí° Want to skip the free account?</strong> <a href="#" onclick="switchToDirectPayment()">Go directly to full purchase</a></p>';
            registerTab.insertBefore(notice, registerTab.firstChild.nextSibling.nextSibling);
        }
    }, 100);
}

function switchToDirectPayment() {
    // Show original pricing form for direct payment
    showLoginScreen();
    // You could implement a direct payment form here
}

function startUpgradeProcess() {
    const upgradeBtn = document.getElementById('upgradeBtn');
    
    if (!currentUser || !currentUser.email) {
        alert('Error: User information not found. Please try logging out and back in.');
        return;
    }
    
    upgradeBtn.disabled = true;
    upgradeBtn.innerHTML = '‚è≥ Redirecting to checkout...';
    
    fetch('/api/create-checkout-session', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ 
            email: currentUser.email,
            username: currentUser.username 
        })
    })
    .then(function(response) {
        return response.json();
    })
    .then(function(data) {
        if (data.url) {
            window.location.href = data.url;
        } else {
            throw new Error(data.error || 'Failed to create checkout session');
        }
    })
    .catch(function(error) {
        console.error('Upgrade error:', error);
        alert('Error starting upgrade: ' + error.message);
        
        upgradeBtn.disabled = false;
        upgradeBtn.innerHTML = 'üîê Upgrade Now - $9.99';
    });
}
    
function showComingSoon() {
    currentView = 'coming-soon';
    updateNavButtons('coming-soon');
    
    // Hide all filters and search bar on Coming Soon page
    document.getElementById('jlptFilter').style.display = 'none';
    document.getElementById('sortFilter').style.display = 'none';
    if (document.getElementById('quizFilter')) {
        document.getElementById('quizFilter').parentElement.style.display = 'none';
    }
    document.querySelector('.search-box').style.display = 'none';
    document.getElementById('pagination').style.display = 'none';
    
    // Remove grid layout for coming soon page
    document.getElementById('content').className = '';
    
    const content = document.getElementById('content');
    content.innerHTML = `
        <div class="coming-soon-page">
            <h2>üöÄ Coming Soon to Kanji Wizard</h2>
            
            <div class="coming-soon-hero">
                <div class="rocket-animation">üöÄ</div>
                <h3>Exciting New Features in Development!</h3>
                <p>We're constantly working to make your Japanese learning experience even better.</p>
            </div>
            
            <div class="features-preview">
                <div class="feature-card">
                    <div class="feature-icon">üì±</div>
                    <h4>Mobile App</h4>
                    <p>Take your Japanese learning on the go with our dedicated mobile apps for iOS and Android.</p>
                    <div class="eta">ETA: Q2 2026</div>
                </div>
                
                <div class="feature-card">
                    <div class="feature-icon">üéôÔ∏è</div>
                    <h4>Audio Pronunciation</h4>
                    <p>Listen to native Japanese pronunciation for all kanji readings and vocabulary words.</p>
                    <div class="eta">ETA: Q1 2026</div>
                </div>
                
                <div class="feature-card">
                    <div class="feature-icon">üí¨</div>
                    <h4>Sentence Examples</h4>
                    <p>See real-world usage examples for every kanji and vocabulary word in context.</p>
                    <div class="eta">ETA: Q1 2026</div>
                </div>
                
                <div class="feature-card">
                    <div class="feature-icon">üèÜ</div>
                    <h4>Achievement System</h4>
                    <p>Earn badges and track milestones as you progress through your Japanese journey.</p>
                    <div class="eta">ETA: Q1 2026</div>
                </div>
                
                <div class="feature-card">
                    <div class="feature-icon">üî•</div>
                    <h4>Streak Tracking</h4>
                    <p>Build daily study habits with streak counters and reminder notifications.</p>
                    <div class="eta">ETA: Q4 2025</div>
                </div>
                
                <div class="feature-card">
                    <div class="feature-icon">üìö</div>
                    <h4>Study Decks</h4>
                    <p>Create and share custom study decks with other learners in the community.</p>
                    <div class="eta">ETA: Q3 2026</div>
                </div>
                
                <div class="feature-card">
                    <div class="feature-icon">ü§ñ</div>
                    <h4>AI Study Assistant</h4>
                    <p>Get personalized study recommendations based on your learning patterns and weak areas.</p>
                    <div class="eta">ETA: Q4 2027</div>
                </div>
                
                <div class="feature-card">
                    <div class="feature-icon">‚úçÔ∏è</div>
                    <h4>Handwriting Practice</h4>
                    <p>Practice writing kanji with stroke order guidance and real-time feedback.</p>
                    <div class="eta">ETA: Q4 2026</div>
                </div>
            </div>
            
            <div class="feedback-section">
                <h3>üí° Have Ideas?</h3>
                <p>We'd love to hear what features you'd like to see next!</p>
                <div class="feedback-actions">
                    <a href="mailto:support@thekanjiwizard.com?subject=Feature Request" class="feedback-btn">
                        üìß Send Feedback
                    </a>
                    <button class="feedback-btn secondary" onclick="showContactModal()">
                        üí¨ Quick Suggestion
                    </button>
                </div>
            </div>
            
            <div class="coming-soon-actions">
                <button class="quiz-btn primary" onclick="showQuiz()">Try Current Features</button>
                <button class="quiz-btn secondary" onclick="showAbout()">Learn More About Us</button>
            </div>
        </div>
    `;
}

// Add this function for the contact modal
function showContactModal() {
    // Create modal if it doesn't exist
    let modal = document.getElementById('contactModal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'contactModal';
        modal.className = 'modal';
        modal.innerHTML = `
            <div class="modal-content">
                <span class="close" onclick="closeContactModal()">&times;</span>
                <div class="modal-header">
                    <h2>üí° Quick Suggestion</h2>
                    <p>What feature would you like to see in Kanji Wizard?</p>
                </div>
                
                <form id="suggestionForm" onsubmit="handleSuggestion(event)">
                    <div class="modal-field">
                        <label for="suggestionText">Your Idea:</label>
                        <textarea id="suggestionText" rows="4" placeholder="I'd love to see..." required></textarea>
                    </div>
                    
                    <div class="modal-field">
                        <label for="suggestionEmail">Email (optional):</label>
                        <input type="email" id="suggestionEmail" placeholder="your@email.com" 
                               value="${isAuthenticated ? currentUser.email : ''}">
                    </div>
                    
                    <div id="suggestionMessage"></div>
                    
                    <div class="modal-actions">
                        <button type="submit" class="modal-btn primary" id="suggestionBtn">
                            Send Suggestion
                        </button>
                        <button type="button" class="modal-btn secondary" onclick="closeContactModal()">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        `;
        document.body.appendChild(modal);
    }
    
    modal.style.display = 'block';
    
    // Close modal when clicking outside
    modal.onclick = function(event) {
        if (event.target === modal) {
            closeContactModal();
        }
    };
}

function closeContactModal() {
    const modal = document.getElementById('contactModal');
    if (modal) {
        modal.style.display = 'none';
        document.getElementById('suggestionForm').reset();
        document.getElementById('suggestionMessage').innerHTML = '';
    }
}

function handleSuggestion(event) {
    event.preventDefault();
    
    const suggestion = document.getElementById('suggestionText').value;
    const email = document.getElementById('suggestionEmail').value;
    const messageDiv = document.getElementById('suggestionMessage');
    const submitBtn = document.getElementById('suggestionBtn');
    
    submitBtn.disabled = true;
    submitBtn.textContent = 'Sending...';
    
    // For now, just show success (you can add backend endpoint later)
    setTimeout(() => {
        messageDiv.innerHTML = '<div class="message success">Thank you for your suggestion! We\'ll consider it for future updates.</div>';
        submitBtn.disabled = false;
        submitBtn.textContent = 'Send Suggestion';
        
        setTimeout(() => {
            closeContactModal();
        }, 2000);
    }, 1000);
}

function subscribeNewsletter() {
    const emailInput = document.getElementById('newsletterEmail');
    const btn = document.querySelector('.newsletter-btn');
    
    if (isAuthenticated) {
        // Already subscribed
        btn.innerHTML = '‚úÖ You\'re Already Subscribed!';
        return;
    }
    
    const email = emailInput.value.trim();
    if (!email || !validateEmail(email)) {
        alert('Please enter a valid email address');
        return;
    }
    
    btn.disabled = true;
    btn.innerHTML = 'üìß Subscribing...';
    
    // For now, just show success (you can add backend endpoint later)
    setTimeout(() => {
        btn.innerHTML = '‚úÖ Subscribed!';
        emailInput.disabled = true;
    }, 1000);
}

function setupUsernameValidation() {
    const usernameInput = document.getElementById('customerUsername');
    const statusDiv = document.getElementById('usernameStatus');
    let debounceTimer;
    
    usernameInput.addEventListener('input', function() {
        const username = this.value.trim();
        
        // Clear previous timer
        clearTimeout(debounceTimer);
        
        // Reset status
        statusDiv.innerHTML = '';
        statusDiv.className = 'username-status';
        
        if (username.length < 3) {
            if (username.length > 0) {
                statusDiv.innerHTML = '‚ö†Ô∏è Username must be at least 3 characters';
                statusDiv.className = 'username-status error';
            }
            return;
        }
        
        if (username.length > 20) {
            statusDiv.innerHTML = '‚ö†Ô∏è Username must be 20 characters or less';
            statusDiv.className = 'username-status error';
            return;
        }
        
        if (!/^[a-zA-Z0-9_]+$/.test(username)) {
            statusDiv.innerHTML = '‚ö†Ô∏è Only letters, numbers, and underscores allowed';
            statusDiv.className = 'username-status error';
            return;
        }
        
        // Show checking status
        statusDiv.innerHTML = 'üîç Checking availability...';
        statusDiv.className = 'username-status checking';
        
        // Debounce the API call
        debounceTimer = setTimeout(() => {
            checkUsernameAvailability(username);
        }, 500);
    });
}

async function checkUsernameAvailability(username) {
    const statusDiv = document.getElementById('usernameStatus');
    
    try {
        const response = await fetch('/api/check-username', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ username: username })
        });
        
        const data = await response.json();
        
        if (data.available) {
            statusDiv.innerHTML = '‚úÖ Username available';
            statusDiv.className = 'username-status available';
        } else {
            statusDiv.innerHTML = '‚ùå Username already taken';
            statusDiv.className = 'username-status taken';
        }
    } catch (error) {
        console.error('Error checking username:', error);
        statusDiv.innerHTML = '‚ö†Ô∏è Could not check availability';
        statusDiv.className = 'username-status error';
    }
}



async function startCheckout() {
    const emailInput = document.getElementById('customerEmail');
    const usernameInput = document.getElementById('customerUsername');
    const checkoutBtn = document.getElementById('checkoutBtn');
    const email = emailInput.value.trim();
    const username = usernameInput.value.trim();
    
    // Validate email
    if (!email) {
        alert('Please enter your email address');
        emailInput.focus();
        return;
    }
    
    if (!validateEmail(email)) {
        alert('Please enter a valid email address');
        emailInput.focus();
        return;
    }
    
    // Validate username
    if (!username) {
        alert('Please choose a username');
        usernameInput.focus();
        return;
    }
    
    if (username.length < 3 || username.length > 20) {
        alert('Username must be between 3 and 20 characters');
        usernameInput.focus();
        return;
    }
    
    if (!/^[a-zA-Z0-9_]+$/.test(username)) {
        alert('Username can only contain letters, numbers, and underscores');
        usernameInput.focus();
        return;
    }
    
    // Check if username is available
    const statusDiv = document.getElementById('usernameStatus');
    if (!statusDiv.classList.contains('available')) {
        alert('Please choose an available username');
        usernameInput.focus();
        return;
    }
    
    // Disable button and show loading
    checkoutBtn.disabled = true;
    checkoutBtn.innerHTML = '‚è≥ Redirecting to checkout...';
    
    try {
        const response = await fetch('/api/create-checkout-session', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
                email: email,
                username: username 
            })
        });
        
        const data = await response.json();
        
        if (data.url) {
            // Redirect to Stripe Checkout
            window.location.href = data.url;
        } else {
            throw new Error(data.error || 'Failed to create checkout session');
        }
        
    } catch (error) {
        console.error('Checkout error:', error);
        alert('Error starting checkout: ' + error.message);
        
        // Re-enable button
        checkoutBtn.disabled = false;
        checkoutBtn.innerHTML = 'üîê Secure Checkout - $9.99';
    }
}

function validateEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
}


// Check if user has temporary password and show warning
function checkTemporaryPassword() {
    if (isAuthenticated && currentUser && currentUser.temp_pass === 1) {
        showTemporaryPasswordWarning();
    }
}

function showTemporaryPasswordWarning() {
    const existingWarning = document.getElementById('tempPasswordWarning');
    if (existingWarning) return; // Don't show multiple warnings
    
    const header = document.querySelector('.header');
    const warning = document.createElement('div');
    warning.id = 'tempPasswordWarning';
    warning.className = 'temp-password-warning';
    warning.innerHTML = `
        <h3>‚ö†Ô∏è Temporary Password Active</h3>
        <p>For security, please change your temporary password to a personal one.</p>
        <button class="change-password-btn" onclick="showPasswordChangeModal()">
            Change Password Now
        </button>
    `;
    
    header.insertAdjacentElement('afterend', warning);
}

function showPasswordChangeModal() {
    // Create modal if it doesn't exist
    let modal = document.getElementById('passwordModal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'passwordModal';
        modal.className = 'modal';
        modal.innerHTML = `
            <div class="modal-content">
                <span class="close" onclick="closePasswordModal()">&times;</span>
                <div class="modal-header">
                    <h2>üîê Change Your Password</h2>
                    <p>Create a secure password for your account</p>
                </div>
                
                <form id="passwordChangeForm" onsubmit="handlePasswordChange(event)">
                    <div class="modal-field">
                        <label for="currentPassword">Current Password:</label>
                        <input type="password" id="currentPassword" required>
                    </div>
                    
                    <div class="modal-field">
                        <label for="newPassword">New Password:</label>
                        <input type="password" id="newPassword" minlength="6" required>
                        <small>Minimum 6 characters</small>
                    </div>
                    
                    <div class="modal-field">
                        <label for="confirmPassword">Confirm New Password:</label>
                        <input type="password" id="confirmPassword" minlength="6" required>
                    </div>
                    
                    <div id="passwordMessage"></div>
                    
                    <div class="modal-actions">
                        <button type="submit" class="modal-btn primary" id="changePasswordBtn">
                            Change Password
                        </button>
                        <button type="button" class="modal-btn secondary" onclick="closePasswordModal()">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        `;
        document.body.appendChild(modal);
    }
    
    modal.style.display = 'block';
    
    // Close modal when clicking outside
    modal.onclick = function(event) {
        if (event.target === modal) {
            closePasswordModal();
        }
    };
}

function closePasswordModal() {
    const modal = document.getElementById('passwordModal');
    if (modal) {
        modal.style.display = 'none';
        // Clear form
        document.getElementById('passwordChangeForm').reset();
        document.getElementById('passwordMessage').innerHTML = '';
    }
}

function handlePasswordChange(event) {
    event.preventDefault();
    
    const currentPassword = document.getElementById('currentPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    const messageDiv = document.getElementById('passwordMessage');
    const changeBtn = document.getElementById('changePasswordBtn');
    
    // Clear previous messages
    messageDiv.innerHTML = '';
    
    // Validate passwords match
    if (newPassword !== confirmPassword) {
        messageDiv.innerHTML = '<div class="message error">New passwords do not match</div>';
        return;
    }
    
    // Validate password strength
    if (newPassword.length < 6) {
        messageDiv.innerHTML = '<div class="message error">Password must be at least 6 characters long</div>';
        return;
    }
    
    // Disable button and show loading
    changeBtn.disabled = true;
    changeBtn.textContent = 'Changing Password...';
    
    fetch('/api/change-password', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            currentPassword: currentPassword,
            newPassword: newPassword
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            messageDiv.innerHTML = '<div class="message success">Password changed successfully!</div>';
            
            // Update current user temp_pass status
            if (currentUser) {
                currentUser.temp_pass = 0;
            }
            
            // Hide temporary password warning
            const warning = document.getElementById('tempPasswordWarning');
            if (warning) {
                warning.remove();
            }
            
            // Close modal after a brief delay
            setTimeout(() => {
                closePasswordModal();
            }, 2000);
        } else {
            messageDiv.innerHTML = `<div class="message error">${data.error}</div>`;
        }
    })
    .catch(error => {
        console.error('Password change error:', error);
        messageDiv.innerHTML = '<div class="message error">An error occurred. Please try again.</div>';
    })
    .finally(() => {
        changeBtn.disabled = false;
        changeBtn.textContent = 'Change Password';
    });
}

document.getElementById('searchInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        searchItems();
    }
});




</script>
</body>
</html>
